<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ذات النقاب / من هنا نبدأ</title>
    
    <meta name="description" content="ذات النقاب">
    <meta name="keywords" content="">
    <meta name="author" content="ذات النقاب">

    <meta property="og:title" content="ذات النقاب">
    <meta property="og:description" content="">
    <meta property="og:image" content="https://images.unsplash.com/photo-1599661046223-16693557e484?q=80&w=1200&h=630&fit=crop">
    <meta property="og:url" content="https://example.com">
    <meta property="og:type" content="website">

    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Marhey:wght@400;700&family=Readex+Pro:wght@300;400;500&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        :root {
            /* Brown Theme Palette */
            --bg-main: #FDF8F2;      /* Very light almond/beige */
            --primary: #8B4513;      /* Saddle Brown - main action color */
            --primary-dark: #654321;  /* Darker brown for active states */
            --secondary: #5C4033;    /* Dark Chestnut for headings */
            --accent: #D2B48C;       /* Tan - for hover effects and highlights */
            --text-main: #6B4F4B;     /* Coffee brown for body text */
            --border-light: #EADDCA; /* Light beige for borders */
            --star-color: #FFA500;   /* Orange for stars */
            --heart-color: #D2691E;  /* Chocolate for hearts */
            --ease-out-quint: cubic-bezier(0.22, 1, 0.36, 1);
        }

        html {
            scroll-behavior: smooth;
            scroll-padding-top: 80px; 
        }

        body {
            font-family: 'Readex Pro', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-main);
            background-image: url('data:image/svg+xml,%3Csvg width="60" height="60" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg"%3E%3Cg fill="none" fill-rule="evenodd"%3E%3Cg fill="%23EADDCA" fill-opacity="0.25"%3E%3Cpath d="M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z"/%3E%3C/g%3E%3C/g%3E%3C/svg%3E');
        }
        
        h1, h2, h3, .font-artistic {
            font-family: 'Marhey', sans-serif;
            color: var(--secondary);
        }

        .stitched-border {
            border: 2px dashed var(--border-light);
            padding: 1rem;
            border-radius: 1rem;
        }
        
        .about-image-wrapper {
            border-radius: 1rem;
            padding: 0.75rem;
            border: 2px dashed var(--primary);
            background-color: rgba(255,255,255,0.6);
        }
         .about-image-wrapper img {
            border-radius: 0.75rem;
         }

        /* --- لمسة جمالية: تم تحديث فاصل الأقسام --- */
        .section-divider {
            height: 60px;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='20' viewBox='0 0 100 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 10 C 20 0, 40 0, 50 10 S 80 20, 100 10' fill='none' stroke='%23D2B48C' stroke-width='1' stroke-linecap='round'/%3E%3Cpath d='M0 15 C 20 5, 40 5, 50 15 S 80 25, 100 15' fill='none' stroke='%238B4513' stroke-width='1.5' stroke-linecap='round' opacity='0.6'/%3E%3C/svg%3E");
            background-repeat: repeat-x;
            background-position: center;
            background-size: 100px 20px;
        }

        .header {
            transition: background-color 0.4s ease, box-shadow 0.4s ease, border-bottom-color 0.4s ease;
        }
        .header.scrolled {
            background-color: rgba(253, 248, 242, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px -1px rgba(92, 64, 51, 0.07);
            /* --- لمسة جمالية: إضافة حد سفلي عند التمرير --- */
            border-bottom: 1px solid var(--border-light);
        }
        .nav-link {
            position: relative;
            transition: color 0.3s ease;
            color: var(--secondary);
        }
        .nav-link:hover, .nav-link.active {
            color: var(--primary);
        }
        .nav-link::after {
            content: '';
            position: absolute;
            bottom: -5px;
            right: 0;
            width: 0;
            height: 2px;
            background-color: var(--primary);
            transition: width 0.4s var(--ease-out-quint);
        }
        .nav-link:hover::after, .nav-link.active::after {
            width: 100%;
        }
        
        #hero-section {
             background-image: linear-gradient(to top, var(--bg-main) 0%, rgba(253, 248, 242, 0) 50%), url(https://images.unsplash.com/photo-1599661046223-16693557e484?q=80&w=1974&auto=format&fit=crop);
            background-size: cover;
            background-position: center;
        }

        @keyframes pulse-breathing {
            0% { transform: scale(1); box-shadow: 0 4px 10px -2px rgba(139, 69, 19, 0.4); }
            50% { transform: scale(1.05); box-shadow: 0 8px 20px -3px rgba(139, 69, 19, 0.5); }
            100% { transform: scale(1); box-shadow: 0 4px 10px -2px rgba(139, 69, 19, 0.4); }
        }

        .btn {
            font-family: 'Marhey', sans-serif;
            background-color: var(--primary);
            color: white;
            font-weight: bold;
            padding: 0.75rem 2rem;
            border-radius: 50px;
            box-shadow: 0 4px 10px -2px rgba(139, 69, 19, 0.5);
            transition: all 0.2s ease;
            border: 2px solid transparent;
            cursor: pointer;
        }
        .btn:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .btn-secondary {
            background-color: transparent;
            color: var(--primary-dark);
            border-color: var(--primary);
        }
         .btn-secondary:hover {
            background-color: var(--accent);
            color: var(--secondary);
         }
        
        #hero-section .btn {
             animation: pulse-breathing 2.5s infinite ease-in-out;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-3px) scale(1.08);
            box-shadow: 0 10px 25px -3px rgba(139, 69, 19, 0.6);
            animation-play-state: paused;
        }
         .btn:active:not(:disabled) {
            transform: translateY(1px) scale(0.98);
            background-color: var(--primary-dark);
            box-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.2);
            animation: none;
        }
        
        /* --- لمسة جمالية: زر مخصص للواتساب --- */
        .btn-whatsapp {
            background-color: #25D366;
            color: white;
        }
        .btn-whatsapp:hover {
            background-color: #128C7E;
            box-shadow: 0 10px 25px -3px rgba(18, 140, 126, 0.5);
        }


        .category-card {
            background-color: #fff;
            border-radius: 1rem;
            box-shadow: 0 4px 15px rgba(92, 64, 51, 0.05);
            transition: all 0.5s var(--ease-out-quint);
            border: 1px solid var(--border-light);
            overflow: hidden;
            position: relative;
        }
        .category-card:hover {
            transform: translateY(-10px) rotate(1deg);
            box-shadow: 0 20px 30px rgba(92, 64, 51, 0.1);
        }
        .category-card-link {
            display: block;
            cursor: pointer;
        }
        
        .category-card .image-container {
            display: grid;
            height: 20rem; /* 320px */
            overflow: hidden;
            gap: 2px; 
        }
        
        .category-card .image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            min-height: 0;
        }

        .image-container[data-image-count="1"] { grid-template-columns: 1fr; }
        .image-container[data-image-count="2"] { grid-template-columns: 1fr 1fr; }
        .image-container[data-image-count="3"] { grid-template-columns: 2fr 1fr; grid-template-rows: 1fr 1fr; }
        .image-container[data-image-count="3"] img:nth-child(1) { grid-row: span 2; }
        .image-container[data-image-count="4"] { grid-template-columns: repeat(2, 1fr); grid-template-rows: repeat(2, 1fr); }
        .image-container[data-image-count="5"] { grid-template-columns: repeat(6, 1fr); grid-template-rows: repeat(2, 1fr); }
        .image-container[data-image-count="5"] img:nth-child(1) { grid-column: span 3; }
        .image-container[data-image-count="5"] img:nth-child(2) { grid-column: span 3; }
        .image-container[data-image-count="5"] img:nth-child(3) { grid-column: span 2; }
        .image-container[data-image-count="5"] img:nth-child(4) { grid-column: span 2; }
        .image-container[data-image-count="5"] img:nth-child(5) { grid-column: span 2; }
        .image-container[data-image-count="6"] { grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(2, 1fr); }
        
        .category-card .title-overlay {
            position: absolute;
            bottom: 0;
            right: 0;
            left: 0;
            padding: 1.25rem 1.5rem;
            background: linear-gradient(to top, rgba(0,0,0,0.8), rgba(0,0,0,0));
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .category-card h3 {
            font-family: 'Marhey', sans-serif;
            color: white;
            font-size: 1.75rem; /* 28px */
            text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
            margin: 0;
        }

        .admin-actions {
            display: flex;
            gap: 0.75rem; /* 12px */
        }
        .action-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(255, 255, 255, 0.4);
            color: white;
            background-color: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
        }
        .action-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
        }
        .action-btn.edit-btn:hover {
            background-color: #3B82F6; /* Blue-500 */
        }
        .action-btn.delete-btn:hover {
            background-color: #EF4444; /* Red-500 */
        }
        
        .product-card {
            background-color: #fff;
            border-radius: 1rem;
            box-shadow: 0 4px 15px rgba(92, 64, 51, 0.05);
            transition: all 0.5s var(--ease-out-quint);
            border: 1px solid var(--border-light);
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        .product-card:hover {
            transform: translateY(-10px) rotate(1deg);
            box-shadow: 0 20px 30px rgba(92, 64, 51, 0.1);
        }
        .product-card .product-content {
            padding: 1rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .product-card .image-container {
            border-bottom: 3px solid var(--border-light);
        }
        .product-card .admin-actions {
            position: absolute;
            top: 0.75rem; /* 12px */
            left: 0.75rem; /* 12px */
            display: flex;
            flex-direction: column;
            gap: 0.5rem; /* 8px */
        }
        
        .product-interactions {
            border-top: 1px solid var(--border-light);
            margin-top: auto; /* Push to bottom */
            padding-top: 0.75rem;
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
        .interaction-btn {
            background: none;
            border: none;
            color: var(--text-main);
            cursor: pointer;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.5rem;
            border-radius: 99px;
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        .interaction-btn:hover {
            background-color: var(--accent);
        }
        .interaction-btn i {
            font-size: 1.1rem;
            transition: transform 0.3s ease;
        }
        .interaction-btn:hover i {
            transform: scale(1.1);
        }
        .interaction-btn.liked i {
            color: var(--heart-color);
            animation: heart-pop 0.5s ease;
        }
        @keyframes heart-pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.4); }
            100% { transform: scale(1); }
        }

        .thumbnail {
             border: 2px solid transparent;
             transition: border-color 0.3s ease;
             border-radius: 0.5rem;
             cursor: pointer;
        }
        .thumbnail.active-thumbnail {
            border-color: var(--primary);
            box-shadow: 0 0 5px rgba(139, 69, 19, 0.5);
        }

        .testimonial-card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 4px 15px rgba(92, 64, 51, 0.05);
            transition: all 0.5s var(--ease-out-quint);
            border: 1px solid var(--border-light);
            padding: 2rem;
            padding-top: 4rem;
            position: relative;
        }
        .testimonial-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 25px rgba(92, 64, 51, 0.08);
        }
        /* --- لمسة جمالية: إضافة علامات اقتباس --- */
        .testimonial-card::before {
            content: '\201C'; /* “ */
            font-family: 'Times New Roman', serif;
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            font-size: 5rem;
            color: var(--border-light);
            line-height: 1;
            z-index: 0;
        }
        .testimonial-card > * {
            position: relative;
            z-index: 1;
        }
        .testimonial-image {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 4px solid white;
            box-shadow: 0 0 0 3px var(--primary);
            position: absolute;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            object-fit: cover;
        }
        .testimonial-card .stars, .star-rating .fa-star {
            color: var(--star-color);
        }

        .testimonial-card .admin-actions {
            position: absolute;
            top: 0.75rem; /* 12px */
            left: 0.75rem; /* 12px */
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .testimonial-card .admin-actions .action-btn {
            background-color: rgba(255, 255, 255, 0.8);
            color: var(--secondary);
            border: 1px solid var(--border-light);
            width: 36px;
            height: 36px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .testimonial-card:hover .admin-actions .action-btn {
            opacity: 1;
        }
        
        .review-interactions {
            padding-top: 1rem;
            margin-top: 1rem;
            border-top: 1px dashed var(--border-light);
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
        .review-comments-container {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-light);
            background-color: #FBF9F6;
            border-radius: 0.5rem;
            padding: 1rem;
        }
        .review-comment-item {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .form-input, .form-textarea, .form-file-input {
            width: 100%; 
            border: 2px solid var(--border-light); 
            border-radius: 0.5rem; 
            padding: 0.75rem 1rem;
            background-color: #fff;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .form-input:focus, .form-textarea:focus, .form-file-input:focus {
            outline: none; 
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(139, 69, 19, 0.4);
        }
        
        .form-file-button {
            display: block;
            width: 100%;
            text-align: center;
            padding: 0.75rem 1rem;
            background-color: #fff;
            border: 2px dashed var(--border-light);
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-main);
        }
        .form-file-button:hover {
            border-color: var(--primary);
            background-color: var(--accent);
        }
        .form-file-button i {
            margin-left: 0.5rem;
        }


        .footer-icon {
            color: var(--secondary);
            background-color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            transition: all 0.4s ease;
            border: 2px solid var(--accent);
            box-shadow: 0 4px 8px rgba(92, 64, 51, 0.15);
        }
        .footer-icon:hover {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary-dark);
            transform: translateY(-5px) scale(1.1);
            box-shadow: 0 6px 15px rgba(92, 64, 51, 0.25);
        }

        #scroll-to-top {
            position: fixed; bottom: 20px; left: 20px; background-color: var(--secondary); color: white;
            width: 50px; height: 50px; border-radius: 10px; display: flex; align-items: center; justify-content: center;
            font-size: 20px; z-index: 100; opacity: 0; visibility: hidden;
            transform: translateY(20px); transition: all 0.4s ease; box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            border: 2px solid white;
        }
        #scroll-to-top:hover { background-color: var(--primary); transform: scale(1.1); }
        #scroll-to-top.visible { opacity: 1; visibility: visible; transform: translateY(0); }
        
        .fade-in-up {
            opacity: 0;
            transform: translateY(30px);
            transition: opacity 0.8s var(--ease-out-quint), transform 0.8s var(--ease-out-quint);
        }
        .fade-in-up.in-view {
            opacity: 1;
            transform: translateY(0);
        }
        @keyframes fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .animate-fade-in {
            animation: fade-in 0.5s ease-out forwards;
        }

        /* --- Modal Styles --- */
        .modal {
            z-index: 150;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            /* --- لمسة جمالية: إضافة خلفية منقوشة للـ Modal --- */
            background-color: rgba(92, 64, 51, 0.8);
            background-image: url('data:image/svg+xml,%3Csvg width="6" height="6" viewBox="0 0 6 6" xmlns="http://www.w3.org/2000/svg"%3E%3Cg fill="%23FFFFFF" fill-opacity="0.05" fill-rule="evenodd"%3E%3Cpath d="M5 0h1L0 6V5zM6 5v1H5z"/%3E%3C/g%3E%3C/svg%3E');
        }
        .modal-content {
            transition: transform 0.4s var(--ease-out-quint);
            transform: translateY(20px) scale(0.95);
        }
        .modal.visible .modal-content {
            transform: translateY(0) scale(1);
        }
        #confirm-modal {
            z-index: 160;
        }
        .star-rating i {
            font-size: 2rem;
            color: var(--border-light);
            cursor: pointer;
            transition: color 0.2s ease, transform 0.2s ease;
        }
        .star-rating i:hover {
            transform: scale(1.2);
        }
        .star-rating i.selected, .star-rating i.hovered {
            color: var(--star-color);
        }
        
        #review-image-preview, #profile-image-preview, #signup-image-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 2px dashed var(--border-light);
            object-fit: cover;
            background-color: #fff;
            cursor: pointer;
        }

        #product-images-preview, #category-images-preview, #edit-item-images-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem; /* 12px */
            margin-top: 0.75rem;
            min-height: 86px;
            border: 2px dashed var(--border-light);
            border-radius: 0.5rem;
            padding: 0.75rem;
            background-color: #fff;
        }
        .image-preview-thumb-wrapper {
             position: relative;
        }
        .image-preview-thumb {
            width: 70px;
            height: 70px;
            border-radius: 0.5rem;
            object-fit: cover;
            border: 1px solid var(--border-light);
        }
        .delete-image-btn {
            position: absolute;
            top: -8px;
            left: -8px;
            width: 24px;
            height: 24px;
            background-color: #EF4444; /* red-500 */
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: all 0.2s ease;
            z-index: 10;
        }
        .delete-image-btn:hover {
            background-color: #DC2626; /* red-600 */
            transform: scale(1.1);
        }

        /* --- Comments Modal Styles --- */
        #comments-list {
        color: white;
            max-height: 50vh;
            overflow-y: auto;
            padding-right: 1rem; /* for scrollbar */
        }
        .comment-item {
            display: flex;
            gap: 1rem;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border-light);
        }
        .comment-item:last-child {
            border-bottom: none;
        }
        .comment-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
        }
        .comment-body {
            flex-grow: 1;
        }
        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.25rem;
        }
        .comment-user {
            font-weight: 500;
            color: var(--secondary);
        }
        .comment-timestamp {
            font-size: 0.75rem;
            color: #9ca3af; /* gray-400 */
        }
        .comment-text {
            line-height: 1.6;
        }
        .comment-actions {
            margin-top: 0.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 0.8rem;
        }
        .comment-action-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: gray;
            font-weight: 500;
        }
        .comment-action-btn:hover {
            text-decoration: underline;
        }
        .comment-replies {
            margin-top: 1rem;
            margin-right: 2rem;
            padding-right: 1rem;
            border-right: 2px solid var(--border-light);
        }
        .reply-form {
            margin-top: 0.5rem;
            display: flex;
            gap: 0.5rem;
        }
        .reply-input {
            flex-grow: 1;
            padding: 0.5rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border-light);
        }

        /* Mobile Menu */
        #mobile-menu-button {
            position: relative;
            z-index: 120;
        }
        #mobile-menu-button i {
            transition: transform 0.5s var(--ease-out-quint);
        }
        .mobile-menu-open #mobile-menu-button i {
            transform: rotate(180deg);
        }
        #mobile-menu {
            z-index: 110;
            transition: transform 0.6s var(--ease-out-quint);
            padding: 6rem 2rem 2rem;
            background-color: rgba(253, 248, 242, 0.85);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }
        .lgg {
            border-radius: 50%;
        }
        #mobile-menu::before {
            content: '';
            position: absolute;
            top: 1.5rem;
            left: 1.5rem;
            right: 1.5rem;
            bottom: 1.5rem;
            border: 2px dashed var(--primary);
            border-radius: 1rem;
            pointer-events: none;
        }
        .mobile-nav-link {
            font-family: 'Marhey', sans-serif;
            font-size: 1.75rem;
            color: var(--secondary);
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            margin: 0 auto 1.25rem;
            background-color: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(234, 221, 202, 0.7);
            box-shadow: 0 4px 15px rgba(92, 64, 51, 0.08);
            width: 80%;
            max-width: 300px;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.4s ease, transform 0.4s ease, background-color 0.3s, color 0.3s;
        }
        .mobile-nav-link:hover {
            background-color: var(--primary);
            color: white;
        }
        .mobile-menu-open .mobile-nav-link {
            opacity: 1;
            transform: translateY(0);
        }

        /* Profile Dropdown */
        .profile-dropdown {
            position: relative;
        }
        .dropdown-menu {
            display: none;
            position: absolute;
            left: 0;
            top: calc(100% + 10px);
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            width: 180px;
            border: 1px solid var(--border-light);
            z-index: 200;
            overflow: hidden;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.2s ease, transform 0.2s ease;
        }
        .profile-dropdown:hover .dropdown-menu {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }
        .dropdown-item {
            display: block;
            padding: 0.75rem 1rem;
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        .dropdown-item:hover {
            background-color: var(--accent);
            color: var(--secondary);
        }
        
        /* Toast Notification */
        #toast-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--secondary);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 200;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.4s ease, transform 0.4s ease;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        #toast-notification.show {
            opacity: 1;
            transform: translateY(0);
        }
        #toast-notification.success {
            background-color: #10B981; /* Emerald-500 */
        }
        #toast-notification.error {
            background-color: #EF4444; /* Red-500 */
        }
        
        
        /* --- كود سكرول الصور المصغرة --- */
        .thumbnail-scroller {
            display: flex;
            overflow-x: auto;
            gap: 0.5rem; /* 8px */
            padding-bottom: 8px; /* مسافة عشان شكل الـ scrollbar */
            scrollbar-width: thin;
            scrollbar-color: var(--primary) var(--accent);
        }

        .thumbnail-scroller::-webkit-scrollbar {
            height: 6px;
        }

        .thumbnail-scroller::-webkit-scrollbar-track {
            background: var(--accent);
            border-radius: 10px;
        }

        .thumbnail-scroller::-webkit-scrollbar-thumb {
            background-color: var(--primary);
            border-radius: 10px;
        }
        
        .text-heart {
            color: var(--heart-color);
        }

        /* --- Shopping Cart Styles --- */
        #cart-button {
            position: relative;
            cursor: pointer;
        }
        #cart-badge {
            position: absolute;
            top: -5px;
            right: -10px;
            background-color: var(--heart-color);
            color: white;
            font-size: 11px;
            font-weight: bold;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--bg-main);
            transform: scale(0);
            transition: transform 0.3s var(--ease-out-quint);
        }
        #cart-badge.active {
            transform: scale(1);
        }

        #cart-modal {
            z-index: 155;
            color: black;
        }
        
        #cart-items-container {
            max-height: 55vh;
            overflow-y: auto;
            padding-right: 1rem;
        }

        .cart-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border-light);
        }
        .cart-item-image {
            width: 70px;
            height: 70px;
            object-fit: cover;
            border-radius: 0.5rem;
            border: 1px solid var(--border-light);
        }
        .cart-item-details {
            flex-grow: 1;
        }
        .cart-item-title {
            font-weight: 500;
            color: black;
        }
        .cart-item-price {
            font-size: 0.9rem;
            color: white;
        }
        .cart-item-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .quantity-input {
            width: 50px;
            text-align: center;
            border: 1px solid var(--border-light);
            border-radius: 0.25rem;
            padding: 0.25rem;
        }
        .remove-cart-item-btn {
            background: none;
            border: none;
            color: #ef4444; /* red-500 */
            cursor: pointer;
            font-size: 1.1rem;
            padding: 0.25rem;
        }
        .remove-cart-item-btn:hover {
            color: #dc2626; /* red-600 */
        }
        
        /* --- لمسة جمالية: تصميم شريط التمرير --- */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
            background-color: var(--bg-main);
        }
        ::-webkit-scrollbar-thumb {
            background-color: var(--accent);
            border-radius: 10px;
            border: 2px solid var(--bg-main);
        }
        ::-webkit-scrollbar-thumb:hover {
            background-color: var(--primary);
        }

        /* --- لمسة جمالية: أيقونة تحميل جذابة --- */
        .lds-heart {
            display: inline-block;
            position: relative;
            width: 80px;
            height: 80px;
            transform: rotate(45deg);
            transform-origin: 40px 40px;
        }
        .lds-heart div {
            top: 32px;
            left: 32px;
            position: absolute;
            width: 32px;
            height: 32px;
            background: var(--primary);
            animation: lds-heart 1.2s infinite cubic-bezier(0.215, 0.61, 0.355, 1);
        }
        .lds-heart div:after,
        .lds-heart div:before {
            content: " ";
            position: absolute;
            display: block;
            width: 32px;
            height: 32px;
            background: var(--primary);
        }
        .lds-heart div:before {
            left: -24px;
            border-radius: 50% 0 0 50%;
        }
        .lds-heart div:after {
            top: -24px;
            border-radius: 50% 50% 0 0;
        }
        @keyframes lds-heart {
            0% { transform: scale(0.95); }
            5% { transform: scale(1.1); }
            39% { transform: scale(0.85); }
            45% { transform: scale(1); }
            60% { transform: scale(0.95); }
            100% { transform: scale(0.9); }
        }

        /* --- لمسة جمالية: تصميم شاشة التحميل الأولية --- */
        @keyframes logo-pop-in {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        @keyframes text-fade-in {
            0% { opacity: 0; transform: translateY(10px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        @keyframes bar-fill {
            from { width: 0%; }
            to { width: 100%; }
        }
        .preloader-logo {
            animation: logo-pop-in 0.8s var(--ease-out-quint) forwards;
        }
        .preloader-text {
            animation: text-fade-in 0.8s var(--ease-out-quint) 0.3s forwards;
            opacity: 0;
        }
        .preloader-bar {
            width: 0;
            height: 3px;
            background-color: var(--primary);
            border-radius: 2px;
            margin: 0 auto;
            max-width: 150px;
            animation: bar-fill 1.5s ease-out 0.5s forwards;
        }
        #ggk {
            color: white;
        }
        #comments-modal-title {
            color: white;
        }
        #p-gk {
            color: white;
        }

    </style>
</head>
<body class="antialiased">

    <!-- لمسة جمالية: شاشة تحميل أولية محسنة -->
    <div id="preloader" class="fixed top-0 left-0 w-full h-full bg-bg-main z-[200] flex items-center justify-center transition-opacity duration-700 ease-in-out">
        <div class="text-center">
            <div class="mb-4">
                <img src="That.jpg" alt="شعار ذات النقاب" class="preloader-logo w-24 h-24 rounded-full object-cover shadow-lg mx-auto border-4 border-white">
            </div>
            <h2 class="text-4xl font-artistic text-secondary preloader-text">ذات النقاب</h2>
            <div class="preloader-bar mt-4"></div>
        </div>
    </div>
    
    <header id="header" class="header sticky top-0 z-40">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-artistic"><a href="#home">ذات النقاب🍂</a></h1>
            
            <div class="hidden md:flex flex-grow items-center justify-center">
                <div id="main-nav" class="flex space-x-8 space-x-reverse items-center font-medium text-lg">
                    <a href="#home" class="nav-link" data-section="home">الرئيسية</a>
                    <a href="#products" class="nav-link" data-section="products">إبداعاتنا</a>
                    <a href="#about" class="nav-link" data-section="about">قصتنا</a>
                    <a href="#testimonials" class="nav-link" data-section="testimonials">آراء العملاء</a>
                    <a href="#contact" class="nav-link" data-section="contact">للتواصل</a>
                </div>
            </div>
            
            <div class="flex items-center space-x-4 space-x-reverse">
                <!-- Cart Icon -->
                <div id="cart-button" class="text-2xl text-secondary">
                    <i class="fas fa-shopping-basket"></i>
                    <span id="cart-badge">0</span>
                </div>

                <div class="hidden md:flex items-center space-x-2 space-x-reverse">
                    <div id="guest-links" class="space-x-2 space-x-reverse">
                        <button id="login-btn" class="font-bold text-secondary px-4 py-2 rounded-full transition-colors hover:bg-accent">تسجيل الدخول</button>
                        <button id="signup-btn" class="btn btn-secondary !px-4 !py-2 !text-sm">حساب جديد</button>
                    </div>

                    <div id="user-profile-display" class="hidden items-center profile-dropdown cursor-pointer">
                        <span id="user-name-display" class="font-bold text-secondary ml-3"></span>
                        <img id="user-avatar-display" src="https://placehold.co/40x40/8B4513/FFFFFF?text=R" alt="صورة المستخدم" class="w-10 h-10 rounded-full object-cover border-2 border-accent">
                        <div class="dropdown-menu">
                            <a href="#" id="edit-profile-btn" class="dropdown-item">
                                <i class="fas fa-user-edit ml-2"></i> تعديل الملف الشخصي
                            </a>
                            <a href="#" id="logout-btn" class="dropdown-item text-red-600">
                                <i class="fas fa-sign-out-alt ml-2"></i> تسجيل الخروج
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="md:hidden flex items-center space-x-2 space-x-reverse">
                <div id="mobile-header-user-display" class="hidden items-center profile-dropdown cursor-pointer ml-auto">
                    <span id="mobile-header-user-name-display" class="font-bold text-secondary ml-2 text-base"></span>
                    <img id="mobile-header-user-avatar-display" src="https://placehold.co/40x40/8B4513/FFFFFF?text=R" alt="صورة المستخدم" class="w-10 h-10 rounded-full object-cover border-2 border-accent">
                    <div id="mobile-header-dropdown-menu" class="dropdown-menu !top-full !-bottom-auto !mt-2 !left-auto !right-0 w-48 invisible opacity-0">
                        <a href="#" id="mobile-header-edit-profile-btn" class="dropdown-item">
                            <i class="fas fa-user-edit ml-2"></i> تعديل الملف الشخصي
                        </a>
                        <a href="#" id="mobile-header-logout-btn" class="dropdown-item text-red-600">
                            <i class="fas fa-sign-out-alt ml-2"></i> تسجيل الخروج
                        </a>
                    </div>
                </div>
                <div id="mobile-header-guest-links" class="hidden space-x-2 space-x-reverse ml-auto">
                    <button id="mobile-header-login-btn" class="font-bold text-secondary px-2 py-1 text-sm rounded-full transition-colors hover:bg-accent">دخول</button>
                    <button id="mobile-header-signup-btn" class="btn btn-secondary !px-2 !py-1 !text-xs">حساب جديد</button>
                </div>
                <button id="mobile-menu-button" class="text-2xl text-secondary focus:outline-none" aria-label="فتح القائمة">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
            
        </nav>
    </header>

    <div id="mobile-menu" class="fixed top-0 right-0 h-full w-full shadow-lg md:hidden p-8 pt-24 text-center transform translate-x-full">
        <div class="flex flex-col h-full justify-center">
             <a href="#home" class="mobile-nav-link">الرئيسية</a>
             <a href="#products" class="mobile-nav-link">إبداعاتنا</a>
             <a href="#about" class="mobile-nav-link">قصتنا</a>
             <a href="#testimonials" class="mobile-nav-link">آراء العملاء</a>
             <a href="#contact" class="mobile-nav-link">للتواصل</a>
             <div class="mt-8">
                <div id="mobile-guest-links">
                     <button id="mobile-login-btn" class="btn w-4/5 max-w-xs mx-auto mb-4">تسجيل الدخول</button>
                     <button id="mobile-signup-btn" class="btn btn-secondary w-4/5 max-w-xs mx-auto">حساب جديد</button>
                </div>
                <div id="mobile-user-links" class="hidden">
                     <button id="mobile-edit-profile-btn" class="btn w-4/5 max-w-xs mx-auto mb-4">ملفي الشخصي</button>
                     <button id="mobile-logout-btn" class="btn btn-secondary w-4/5 max-w-xs mx-auto !border-red-500 !text-red-500">تسجيل الخروج</button>
                </div>
             </div>
        </div>
    </div>


    <main>
       <section id="home" class="nav-section min-h-screen flex items-center justify-center text-center py-20">
            <div class="hero-content container mx-auto px-6 z-10">
                <div class="fade-in-up">
                    <div id="hero-image-wrapper" class="about-image-wrapper shadow-lg max-w-xs mx-auto mb-8 relative group">
                        <img id="hero-image" src="That.jpg" alt="صورة فنية عن الموقع" class="w-full" loading="lazy">
                        <input type="file" id="hero-image-input" class="hidden" accept="image/*">
                        <label for="hero-image-input" id="edit-hero-image-btn" aria-label="تعديل الصورة الرئيسية" class="hidden absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-black/60 text-white w-14 h-14 rounded-full flex items-center justify-center text-2xl opacity-0 group-hover:opacity-100 transition-opacity duration-300 cursor-pointer border-2 border-white/50 hover:bg-black/80">
                            <i class="fas fa-edit"></i>
                        </label>
                    </div>
                </div>
                <div class="fade-in-up" style="transition-delay: 0.1s;">
                    <h2 class="text-5xl md:text-8xl font-artistic drop-shadow-lg mb-4" style="color: var(--secondary); text-shadow: 1px 1px 3px rgba(253, 248, 242, 0.4);">لمسة فن.. تروي حكاية</h2>
                </div>
                <div class="fade-in-up" style="transition-delay: 0.3s;">
                    <p class="text-lg md:text-xl max-w-2xl mx-auto mb-8 font-medium" style="color: var(--text-main); text-shadow: 1px 1px 3px rgba(255, 255, 255, 0.5);">
                        نصنع قطعاً فنية تحمل دفء الأيدي وشغف القلوب، لتكون جزءاً من أسعد لحظاتكم.
                    </p>
                </div>
                <div class="fade-in-up" style="transition-delay: 0.5s;">
                    <a href="#products" class="btn">اكتشفوا الإبداع</a>
                </div>
            </div>
        </section>

        <section id="products" class="py-24 nav-section">
            <div class="container mx-auto px-6">
                <div class="text-center mb-6 fade-in-up">
                    <h3 class="font-artistic text-5xl">إبداعاتنا</h3>
                </div>
                <div class="text-center mb-12 fade-in-up" style="transition-delay: 0.1s;">
                    <p class="mt-2 text-gray-600 max-w-xl mx-auto">كل قطعة نصنعها هي لوحة فنية فريدة، مليئة بالحب والشغف. اختر قسمًا لتستكشفه.</p>
                </div>
                <div class="section-divider mb-12"></div>
                
                <div id="products-display-area" class="fade-in-up" style="transition-delay: 0.2s;">
                     <div class="text-center p-8 text-gray-500">
                        <i class="fas fa-spinner fa-spin text-3xl"></i>
                        <p class="mt-2">جاري تحميل الأقسام...</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="about" class="py-24 nav-section overflow-hidden bg-white">
            <div class="container mx-auto px-6">
                <div class="section-divider mb-12"></div>
                 <div class="flex flex-col lg:flex-row items-center gap-12 lg:gap-20">
                    <div class="lg:w-1/2 fade-in-up">
                        <div class="about-image-wrapper shadow-lg">
                            <img src="That.jpg" 
                                 alt="صورة مقربة عن التصميم" class="w-full" loading="lazy">
                        </div>
                    </div>
                    <div class="lg:w-1/2 text-center lg:text-right">
                        <div class="fade-in-up"><h2 class="font-artistic text-5xl mb-6">قصتنا</h2></div>
                        <div class="fade-in-up" style="transition-delay: 0.2s;">
                            <p class="text-lg text-gray-700 leading-relaxed mb-4">
                                بدأ كل شيء بحلم صغير بتحويل المشاعر إلى فن ملموس. في ذات النقاب، كل قطعة هي كلمة في قصة حب نصنعها خصيصاً لك.
                            </p>
                        </div>
                        <div class="fade-in-up" style="transition-delay: 0.4s;">
                             <p class="text-lg text-gray-700 leading-relaxed">
                                نؤمن أن الجمال يكمن في التفاصيل، ولهذا نكرس وقتنا وشغفنا لنقدم لك قطعة فريدة لا تشبه إلا حكايتك.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <section id="testimonials" class="py-24 nav-section bg-bg-main">
            <div class="container mx-auto px-6">
                <div class="text-center mb-6 fade-in-up">
                    <h2 class="font-artistic text-5xl">قالوا عن إبداعاتنا</h2>
                </div>
                <div class="text-center mb-12 fade-in-up" style="transition-delay: 0.1s;">
                    <p class="mt-2 text-gray-600 max-w-xl mx-auto">شهادات نعتز بها من عملائنا، هي وقودنا لنستمر في الإبداع.</p>
                </div>
                <div class="section-divider mb-12"></div>
                
                <div id="testimonials-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-8 gap-y-16 pt-10">
                    <div class="text-center p-8 text-gray-500 md:col-span-2 lg:col-span-3">
                        <i class="fas fa-spinner fa-spin text-3xl"></i>
                        <p class="mt-2">جاري تحميل آراء العملاء...</p>
                    </div>
                </div>

                <div class="text-center mt-12 fade-in-up">
                    <button id="add-review-btn" class="btn">
                        <i class="fas fa-pen-nib ml-2"></i> أضف رأيك
                    </button>
                </div>
            </div>
        </section>

        <section id="contact" class="py-24 nav-section bg-white">
            <div class="container mx-auto px-6">
                 <div class="text-center mb-6 fade-in-up">
                    <h2 class="font-artistic text-5xl mb-4">للتواصل والإلهام</h2>
                    <p class="text-lg text-gray-600 max-w-2xl mx-auto">
                        هل لديك فكرة تود تحقيقها؟ شاركنا حلمك ودعنا نحوله إلى حقيقة.
                    </p>
                </div>
                <div class="section-divider mb-12"></div>

                <div class="max-w-3xl mx-auto bg-bg-main p-8 sm:p-12 rounded-2xl shadow-lg stitched-border fade-in-up" style="transition-delay: 0.2s;">
                    <form id="contact-form" class="space-y-6">
                        <div class="flex flex-col sm:flex-row gap-6">
                            <div class="w-full">
                                <label for="name" class="font-medium mb-2 block">الاسم</label>
                                <input type="text" id="name" name="name" placeholder="الاسم بالكامل" class="form-input" required>
                            </div>
                            <div class="w-full">
                                <label for="email" class="font-medium mb-2 block">البريد الإلكتروني</label>
                                <input type="email" id="email" name="email" placeholder="بريدك الإلكتروني" class="form-input" required>
                            </div>
                        </div>
                        <div>
                            <label for="message" class="font-medium mb-2 block">رسالتك</label>
                            <textarea id="message" name="message" rows="5" placeholder="اكتب رسالتك أو تفاصيل طلبك هنا..." class="form-textarea" required></textarea>
                        </div>
                        <div class="text-center pt-4">
                            <button type="submit" class="btn">
                                إرسال الرسالة <i class="fas fa-paper-plane mr-2"></i>
                            </button>
                        </div>
                    </form>
                    <div id="form-status" class="mt-6 text-center font-medium"></div>
                </div>
            </div>
        </section>
    </main>

    <footer class="bg-secondary text-white pt-16 pb-8 mt-20 relative">
        <div class="absolute top-0 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-bg-main p-2 rounded-full">
            <div class="bg-secondary text-white w-20 h-20 rounded-full flex items-center justify-center">
              <img class="lgg" src="That.jpg" alt="شعار ذات النقاب">
            </div>
        </div>
        <div class="container mx-auto px-6 text-center">
             <div class="flex flex-wrap justify-center items-center gap-4 mb-8">
                <a href="#" target="_blank" aria-label="Instagram" class="footer-icon"><i class="fab fa-instagram"></i></a>
                <a href="https://www.facebook.com/share/19XSqrwk8V/" target="_blank" aria-label="Facebook" class="footer-icon"><i class="fab fa-facebook"></i></a>
                <a href="https://wa.me/+201016712554" target="_blank" aria-label="WhatsApp" class="footer-icon"><i class="fab fa-whatsapp"></i></a>
                <a href="tel:+201016712554" aria-label="اتصال" class="footer-icon"><i class="fas fa-phone"></i></a>
                <a href="mailto:#" aria-label="Email" class="footer-icon"><i class="fas fa-envelope"></i></a>
            </div>
            <p class="text-sm text-gray-300">&copy; 2025 ذات النقاب. كل الحقوق محفوظة.</p>
            <p class="text-sm text-gray-300 mt-1">صُنع بكل حب وشغف <i class="fas fa-heart text-heart"></i></p>
        </div>
    </footer>
    
    <!-- Toast Notification -->
    <div id="toast-notification">
        <i id="toast-icon" class="fas fa-check-circle text-xl"></i>
        <span id="toast-message"></span>
    </div>

    <!-- Scroll to Top Button -->
    <button id="scroll-to-top" aria-label="العودة للأعلى">
        <i class="fas fa-arrow-up"></i>
    </button>
    
    <!-- Modals -->
    <div id="image-modal" role="dialog" aria-modal="true" class="modal fixed top-0 left-0 w-full h-full backdrop-blur-sm flex items-center justify-center opacity-0 invisible">
        <button class="close-modal absolute top-6 right-6 text-white text-4xl" aria-label="إغلاق الصورة">&times;</button>
        <img src="" alt="صورة المنتج بحجم كبير" id="modal-img" class="modal-content max-w-[90%] max-h-[90%] object-contain rounded-lg shadow-2xl">
    </div>
    
    <div id="review-modal" role="dialog" aria-modal="true" aria-labelledby="review-modal-title" class="modal fixed top-0 left-0 w-full h-full backdrop-blur-sm flex items-center justify-center opacity-0 invisible p-4">
        <div class="modal-content relative max-w-lg w-full bg-bg-main p-8 rounded-2xl shadow-lg stitched-border">
            <button class="close-review-modal absolute top-4 left-4 text-2xl text-secondary hover:text-primary" aria-label="إغلاق النافذة">&times;</button>
            <h2 id="review-modal-title" class="font-artistic text-3xl text-center mb-6">شاركنا رأيك</h2>
            <form id="review-form" class="space-y-5">
                <input type="hidden" id="review-id-input">
                <div class="flex flex-col items-center">
                    <img id="review-image-preview" src="https://placehold.co/100x100/EADDCA/5C4033?text=صورتك" alt="معاينة الصورة الشخصية">
                    <span id="review-name-display" class="font-bold text-lg mt-2 text-secondary"></span>
                </div>
                <div>
                    <label class="font-medium mb-3 block text-center">تقييمك</label>
                    <div class="star-rating flex justify-center items-center gap-2" data-rating="0">
                        <i class="far fa-star" data-value="1"></i><i class="far fa-star" data-value="2"></i><i class="far fa-star" data-value="3"></i><i class="far fa-star" data-value="4"></i><i class="far fa-star" data-value="5"></i>
                    </div>
                     <input type="hidden" name="rating" id="rating" value="0" required>
                </div>
                <div>
                    <label for="review-comment" class="font-medium mb-2 block">تعليقك</label>
                    <textarea id="review-comment" name="comment" rows="4" placeholder="اكتب رأيك في منتجاتنا هنا..." class="form-textarea" required></textarea>
                </div>
                <div class="text-center pt-4">
                    <button type="submit" class="btn">إرسال الرأي <i class="fas fa-check mr-2"></i></button>
                </div>
            </form>
        </div>
    </div>

    <div id="login-modal" class="modal fixed top-0 left-0 w-full h-full backdrop-blur-sm flex items-center justify-center opacity-0 invisible p-4">
        <div class="modal-content relative max-w-md w-full bg-bg-main p-8 rounded-2xl shadow-lg stitched-border">
            <button id="p-gk" class="close-modal-btn absolute top-4 left-4 text-2xl text-secondary hover:text-primary" aria-label="إغلاق">&times;</button>
            <h2 class="font-artistic text-3xl text-center mb-6">تسجيل الدخول</h2>
            <form id="login-form" class="space-y-5">
                <div>
                    <label for="login-email" class="font-medium mb-2 block">البريد الإلكتروني</label>
                    <input type="email" id="login-email" class="form-input" required>
                </div>
                <div>
                    <label for="login-password" class="font-medium mb-2 block">كلمة المرور</label>
                    <input type="password" id="login-password" class="form-input" required>
                </div>
                <div class="text-center pt-4">
                    <button type="submit" class="btn w-full">دخول</button>
                </div>
                <div class="text-center pt-4">
                    <p class="text-sm text-gray-600">
                        ليس لديك حساب؟ 
                        <a href="#" id="switch-to-signup" class="font-medium text-primary hover:text-primary-dark transition-colors">
                            أنشئ حساباً جديداً
                        </a>
                    </p>
                </div>
            </form>
        </div>
    </div>
    
    <div id="signup-modal" class="modal fixed top-0 left-0 w-full h-full backdrop-blur-sm flex items-center justify-center opacity-0 invisible p-4">
        <div class="modal-content relative max-w-md w-full bg-bg-main p-8 rounded-2xl shadow-lg stitched-border overflow-y-auto max-h-[90vh]">
            <button id="p-gk" class="close-modal-btn absolute top-4 left-4 text-2xl text-secondary hover:text-primary" aria-label="إغلاق">&times;</button>
            <h2 class="font-artistic text-3xl text-center mb-6">إنشاء حساب جديد</h2>
            <form id="signup-form" class="space-y-4">
                 <div class="flex flex-col items-center">
                    <label for="signup-image-input">
                        <img id="signup-image-preview" src="https://placehold.co/80x80/EADDCA/5C4033?text=اختيار" alt="اختيار صورة شخصية">
                    </label>
                    <input type="file" id="signup-image-input" class="hidden" accept="image/*">
                    <small class="mt-2 text-gray-500">اختر صورة شخصية (اختياري)</small>
                </div>
                 <div>
                    <label for="signup-name" class="font-medium mb-2 block">الاسم</label>
                    <input type="text" id="signup-name" placeholder="اسمك الكامل" class="form-input" required>
                </div>
                <div>
                    <label class="font-medium mb-2 block">نوع الحساب</label>
                    <div class="flex items-center gap-x-6">
                        <label class="flex items-center gap-x-2 cursor-pointer text-gray-700">
                            <input type="radio" name="accountType" value="visitor" class="w-4 h-4 text-primary focus:ring-primary-dark" checked>
                            <span>زائر</span>
                        </label>
                        <label class="flex items-center gap-x-2 cursor-pointer text-gray-700">
                            <input type="radio" name="accountType" value="admin" class="w-4 h-4 text-primary focus:ring-primary-dark">
                            <span>مسؤول</span>
                        </label>
                    </div>
                </div>
                <div>
                    <label for="signup-email" class="font-medium mb-2 block">البريد الإلكتروني</label>
                    <input type="email" id="signup-email" placeholder="email@example.com" class="form-input" required>
                </div>
                 <div>
                    <label for="signup-phone" class="font-medium mb-2 block">رقم الهاتف</label>
                    <input type="tel" id="signup-phone" placeholder="01xxxxxxxx" class="form-input">
                </div>
                <div>
                    <label for="signup-birthdate" class="font-medium mb-2 block">تاريخ الميلاد</label>
                    <input type="date" id="signup-birthdate" class="form-input" required>
                </div>
                <div>
                    <label for="signup-password" class="font-medium mb-2 block">كلمة المرور</label>
                    <input type="password" id="signup-password" placeholder="6 أحرف على الأقل" class="form-input" required>
                </div>
                 <div>
                    <label for="signup-address" class="font-medium mb-2 block">العنوان</label>
                    <textarea id="signup-address" rows="3" placeholder="عنوان الشحن بالتفصيل" class="form-textarea"></textarea>
                </div>
                <div class="text-center pt-4">
                    <button type="submit" class="btn w-full">إنشاء حساب</button>
                </div>
                <div class="text-center pt-2">
                    <p class="text-sm text-gray-600">
                        لديك حساب بالفعل؟
                        <a href="#" id="switch-to-login" class="font-medium text-primary hover:text-primary-dark transition-colors">
                            سجل الدخول
                        </a>
                    </p>
                </div>
            </form>
        </div>
    </div>
    
    <div id="admin-pass-modal" role="dialog" aria-modal="true" aria-labelledby="admin-pass-modal-title" class="modal fixed top-0 left-0 w-full h-full backdrop-blur-sm flex items-center justify-center opacity-0 invisible p-4">
        <div class="modal-content relative max-w-md w-full bg-bg-main p-8 rounded-2xl shadow-lg stitched-border text-center">
            <h2 id="admin-pass-modal-title" class="font-artistic text-2xl mb-2">تسجيل حساب مسؤول</h2>
            <p class="mb-6 text-gray-600">لإتمام العملية، يرجى إدخال كلمة مرور المسؤول.</p>
            <form id="admin-pass-form">
                <label for="admin-pass-input" class="sr-only">كلمة مرور المسؤول</label>
                <input type="password" id="admin-pass-input" class="form-input text-center tracking-widest" required>
                <div class="flex justify-center gap-4 mt-6">
                    <button type="button" id="cancel-admin-pass-btn" class="btn btn-secondary">إلغاء</button>
                    <button type="submit" class="btn">موافق</button>
                </div>
            </form>
        </div>
    </div>
    <div id="profile-modal" class="modal fixed top-0 left-0 w-full h-full backdrop-blur-sm flex items-center justify-center opacity-0 invisible p-4">
        <div class="modal-content relative max-w-lg w-full bg-bg-main p-8 rounded-2xl shadow-lg stitched-border overflow-y-auto max-h-[90vh]">
            <button id="p-gk" class="close-modal-btn absolute top-4 left-4 text-2xl text-secondary hover:text-primary" aria-label="إغلاق">&times;</button>
            <h2 class="font-artistic text-3xl text-center mb-6">تعديل الملف الشخصي</h2>
            <form id="profile-form" class="space-y-4">
                 <div class="flex flex-col items-center">
                    <label for="profile-image-input">
                        <img id="profile-image-preview" src="https://placehold.co/80x80/EADDCA/5C4033?text=تغيير" alt="تغيير الصورة الشخصية">
                    </label>
                    <input type="file" id="profile-image-input" class="hidden" accept="image/*">
                    <small class="mt-2 text-gray-500">اضغط على الصورة لتغييرها</small>
                </div>
                <div>
                    <label for="profile-name" class="font-medium mb-2 block">الاسم</label>
                    <input type="text" id="profile-name" class="form-input" required>
                </div>
                 <div>
                    <label for="profile-phone" class="font-medium mb-2 block">رقم الهاتف</label>
                    <input type="tel" id="profile-phone" class="form-input">
                </div>
                 <div>
                    <label for="profile-birthdate" class="font-medium mb-2 block">تاريخ الميلاد</label>
                    <input type="text" id="profile-birthdate" class="form-input bg-gray-100" readonly>
                </div>
                <div>
                    <label for="profile-email" class="font-medium mb-2 block">البريد الإلكتروني</label>
                    <input type="text" id="profile-email" class="form-input bg-gray-100" readonly>
                </div>
                 <div>
                    <label for="profile-address" class="font-medium mb-2 block">العنوان</label>
                    <textarea id="profile-address" rows="3" class="form-textarea"></textarea>
                </div>
                <div class="text-center pt-4">
                    <button type="submit" class="btn">حفظ التعديلات</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="add-category-modal" class="modal fixed top-0 left-0 w-full h-full backdrop-blur-sm flex items-center justify-center opacity-0 invisible p-4">
        <div class="modal-content relative max-w-md w-full bg-bg-main p-8 rounded-2xl shadow-lg stitched-border">
            <button id="p-gk" class="close-modal-btn absolute top-4 left-4 text-2xl text-secondary hover:text-primary" aria-label="إغلاق">&times;</button>
            <h2 id="p-gk" class="font-artistic text-3xl text-center mb-6">إضافة قسم جديد</h2>
            <form id="add-category-form" class="space-y-5">
                <div>
                    <label for="category-name-input" class="font-medium mb-2 block" id="p-gk">اسم القسم</label>
                    <input type="text" id="category-name-input" placeholder="مثال: # " class="form-input" required>
                </div>
                <div>
                    <label for="category-images-input" class="form-file-button">
                        <i class="fas fa-upload"></i> اختر صور القسم (يمكن اختيار أكثر من صورة)
                    </label>
                    <input type="file" id="category-images-input" class="hidden" accept="image/*" multiple required>
                    <div id="category-images-preview"></div>
                </div>
                <div class="text-center pt-4">
                    <button type="submit" class="btn w-full">حفظ القسم</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="add-product-modal" class="modal fixed top-0 left-0 w-full h-full backdrop-blur-sm flex items-center justify-center opacity-0 invisible p-4">
        <div class="modal-content relative max-w-md w-full bg-bg-main p-8 rounded-2xl shadow-lg stitched-border overflow-y-auto max-h-[90vh]">
            <button id="p-gk" class="close-modal-btn absolute top-4 left-4 text-2xl text-secondary hover:text-primary" aria-label="إغلاق">&times;</button>
            <h2 id="p-gk" class="font-artistic text-3xl text-center mb-6">إضافة منتج جديد</h2>
            <form id="add-product-form" class="space-y-4">
                <input type="hidden" id="product-category-id-input">
                <div>
                    <label for="product-name-input" class="font-medium mb-2 block" id="p-gk">اسم المنتج</label>
                    <input type="text" id="product-name-input" placeholder="#" class="form-input" required>
                </div>
                <div>
                    <label for="product-price-input" class="font-medium mb-2 block" id="p-gk">السعر (بالجنيه المصري)</label>
                    <input type="number" id="product-price-input" placeholder="مثال: 250" class="form-input" required min="0">
                </div>
                 <div>
                    <label for="product-images-input" class="font-medium mb-2 block" id="p-gk">صور المنتج (يمكنك اختيار أكثر من صورة)</label>
                    <label for="product-images-input" class="form-file-button">
                        <i class="fas fa-images"></i> اختر الصور
                    </label>
                    <input type="file" id="product-images-input" class="hidden" accept="image/*" multiple>
                    <div id="product-images-preview"></div>
                </div>
                <div class="text-center pt-4">
                    <button type="submit" class="btn w-full">حفظ المنتج</button>
                </div>
            </form>
        </div>
    </div>

    <div id="edit-item-modal" class="modal fixed top-0 left-0 w-full h-full backdrop-blur-sm flex items-center justify-center opacity-0 invisible p-4">
        <div class="modal-content relative max-w-lg w-full bg-bg-main p-8 rounded-2xl shadow-lg stitched-border overflow-y-auto max-h-[90vh]">
            <button id="p-gk" class="close-modal-btn absolute top-4 left-4 text-2xl text-secondary hover:text-primary" aria-label="إغلاق">&times;</button>
            <h2 id="edit-item-modal-title" class="font-artistic text-3xl text-center mb-6">تعديل العنصر</h2>
            <form id="edit-item-form" class="space-y-4">
                <input type="hidden" id="edit-item-id-input">
                <input type="hidden" id="edit-item-type-input">
                <input type="hidden" id="edit-item-category-id-input">
                <div>
                    <label for="edit-item-name-input" class="font-medium mb-2 block">الاسم</label>
                    <input type="text" id="edit-item-name-input" class="form-input" required>
                </div>
                <div id="edit-item-price-container" class="hidden">
                    <label for="edit-item-price-input" class="font-medium mb-2 block">السعر</label>
                    <input type="number" id="edit-item-price-input" class="form-input" min="0">
                </div>
                 <div>
                    <label class="font-medium mb-2 block">الصور الحالية (اضغط <i class="fas fa-times text-red-500"></i> لحذف صورة)</label>
                    <div id="edit-item-images-preview"></div>
                </div>
                <div>
                     <label for="edit-item-images-input" class="form-file-button">
                        <i class="fas fa-plus"></i> إضافة صور جديدة
                    </label>
                    <input type="file" id="edit-item-images-input" class="hidden" accept="image/*" multiple>
                </div>
                <div class="text-center pt-4">
                    <button type="submit" class="btn w-full">حفظ التعديلات</button>
                </div>
            </form>
        </div>
    </div>

    <div id="confirm-modal" role="dialog" aria-modal="true" aria-labelledby="confirm-modal-title" class="modal fixed top-0 left-0 w-full h-full backdrop-blur-sm flex items-center justify-center opacity-0 invisible p-4">
        <div class="modal-content relative max-w-sm w-full bg-bg-main p-8 rounded-2xl shadow-lg stitched-border text-center">
             <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-red-100 mb-4">
                <i class="fas fa-exclamation-triangle text-3xl text-red-500"></i>
            </div>
            <h2 id="confirm-modal-title" class="font-artistic text-2xl mb-2">هل أنت متأكد؟</h2>
            <p id="confirm-modal-text" class="mb-6 text-gray-600">سيتم حذف هذا العنصر نهائياً. لا يمكن التراجع عن هذا الإجراء.</p>
            <div class="flex justify-center gap-4">
                <button id="confirm-modal-cancel-btn" class="btn btn-secondary">إلغاء</button>
                <button id="confirm-modal-confirm-btn" class="btn !bg-red-500 hover:!bg-red-600">تأكيد الحذف</button>
            </div>
        </div>
    </div>

    <!-- Comments Modal -->
    <div id="comments-modal" class="modal fixed top-0 left-0 w-full h-full backdrop-blur-sm flex items-center justify-center opacity-0 invisible p-4">
        <div class="modal-content relative max-w-2xl w-full bg-bg-main p-8 rounded-2xl shadow-lg stitched-border flex flex-col max-h-[90vh]">
            <button id="p-gk" class="close-modal-btn absolute top-4 left-4 text-2xl text-secondary hover:text-primary" aria-label="إغلاق">&times;</button>
            <h2 id="comments-modal-title" class="font-artistic text-3xl text-center mb-6">تعليقات المنتج</h2>
            <div id="comments-list" class="flex-grow pr-4 -mr-4 overflow-y-auto">
                <!-- Comments will be rendered here -->
                <div class="text-center p-8 text-gray-500">
                    <i class="fas fa-spinner fa-spin text-3xl"></i>
                    <p class="mt-2">جاري تحميل التعليقات...</p>
                </div>
            </div>
            <div id="add-comment-section" class="pt-6 border-t border-border-light">
                <form id="add-comment-form" class="space-y-4">
                    <input type="hidden" id="comment-product-id-input">
                    <div>
                        <label for="new-comment-input" class="font-medium mb-2 block sr-only">أضف تعليقك</label>
                        <textarea id="new-comment-input" rows="3" placeholder="اكتب تعليقك هنا..." class="form-textarea" required></textarea>
                    </div>
                    <div class="text-left">
                        <button type="submit" class="btn !rounded-lg !px-6">أضف تعليق</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Cart Modal -->
    <div id="cart-modal" class="modal fixed top-0 left-0 w-full h-full backdrop-blur-sm flex items-center justify-center opacity-0 invisible p-4">
        <div class="modal-content relative max-w-lg w-full bg-bg-main p-6 sm:p-8 rounded-2xl shadow-lg stitched-border flex flex-col max-h-[90vh]">
            <button id="p-gk" class="close-modal-btn absolute top-4 left-4 text-2xl text-secondary hover:text-primary" aria-label="إغلاق">&times;</button>
            <h2 id="ggk" class="font-artistic text-3xl text-center mb-6">سلة التسوق</h2>
            
            <div id="cart-items-container" class="flex-grow mb-4 -mr-4 pr-4">
                <!-- Cart items will be rendered here -->
                <div id="empty-cart-message" class="flex flex-col items-center justify-center h-full text-center text-gray-500">
                    <i class="fas fa-shopping-basket text-5xl mb-4"></i>
                    <p>سلتك فارغة حالياً.</p>
                </div>
            </div>

            <div id="cart-footer" class="pt-4 border-t border-border-light hidden">
                <div class="flex justify-between items-center font-bold text-lg mb-4">
                    <span class="text-secondary">الإجمالي:</span>
                    <span id="cart-total-price" class="text-primary-dark">0 جنيه</span>
                </div>
                <div class="flex flex-col sm:flex-row gap-4">
                    <button id="clear-cart-btn" class="btn btn-secondary !border-red-500 !text-red-500 w-full">
                        <i class="fas fa-trash-alt ml-2"></i> إفراغ السلة
                    </button>
                    <!-- لمسة جمالية: زر مخصص للواتساب -->
                    <button id="checkout-btn" class="btn btn-whatsapp w-full">
                        إتمام الطلب عبر واتساب <i class="fab fa-whatsapp mr-2"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>


    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            onAuthStateChanged, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc, 
            updateDoc,
            collection,
            addDoc,
            getDocs,
            deleteDoc,
            query,
            where,
            onSnapshot,
            serverTimestamp,
            runTransaction,
            increment,
            arrayUnion,
            arrayRemove
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration from user
        const firebaseConfig = {
          apiKey: "AIzaSyAq1vYZTVBGNiA95fBNczTkq0hjE84UuEc",
          authDomain: "handmade-433be.firebaseapp.com",
          projectId: "handmade-433be",
          storageBucket: "handmade-433be.appspot.com",
          messagingSenderId: "575969033444",
          appId: "1:575969033444:web:36c519ae6b7f879625c0f1"
        };


        // --- App State ---
        let app, auth, db;
        let currentUser = null; // Will hold { uid, email, name, role, imageUrl, ... }
        let unsubscribeCategories, unsubscribeProducts, unsubscribeReviews, unsubscribeComments, unsubscribeReviewComments;
        let revealObserver;
        let activeReviewCommentListeners = {}; // To manage multiple listeners for review comments
        let cart = []; // Shopping cart state

        // Initialize Firebase
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            console.log("Firebase initialized successfully.");
        } catch (error) {
            console.error("Error initializing Firebase:", error);
            document.body.innerHTML = '<div class="w-screen h-screen flex items-center justify-center text-center p-8"><h1>عذراً، خدمات الموقع غير متاحة حالياً. يرجى المحاولة لاحقاً.</h1></div>';
        }
       
        document.addEventListener('DOMContentLoaded', () => {

            // --- UI Elements ---
            const guestLinks = document.getElementById('guest-links');
            const userProfileDisplay = document.getElementById('user-profile-display');
            const userNameDisplay = document.getElementById('user-name-display');
            const userAvatarDisplay = document.getElementById('user-avatar-display');
            
            const mobileGuestLinks = document.getElementById('mobile-guest-links');
            const mobileUserLinks = document.getElementById('mobile-user-links');
            
            let reviewModal, loginModal, signupModal, profileModal, addCategoryModal, addProductModal, imageModal, editItemModal, confirmModal, adminPassModal, commentsModal, cartModal;

            const compressAndEncodeImage = file => new Promise((resolve, reject) => {
                const MAX_WIDTH = 800; 
                const IMAGE_QUALITY = 0.6; 

                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = event => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        if (width > MAX_WIDTH) {
                            const scaleSize = MAX_WIDTH / img.width;
                            width = MAX_WIDTH;
                            height = img.height * scaleSize;
                        }

                        canvas.width = width;
                        canvas.height = height;

                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        const compressedBase64 = ctx.canvas.toDataURL('image/jpeg', IMAGE_QUALITY);
                        resolve(compressedBase64);
                    };
                    img.onerror = error => reject(error);
                };
                reader.onerror = error => reject(error);
            });
            
            
            let toastTimeoutId = null; 

            const showToast = (message, type = 'success', duration = 3000) => {
                const toast = document.getElementById('toast-notification');
                const toastMessage = document.getElementById('toast-message');
                const toastIcon = document.getElementById('toast-icon');

                if (toastTimeoutId) {
                    clearTimeout(toastTimeoutId);
                }

                toastMessage.textContent = message;
                toast.className = 'show'; 
                toastIcon.className = ''; 

                if (type === 'success') {
                    toast.classList.add('success');
                    toastIcon.classList.add('fas', 'fa-check-circle', 'text-xl');
                } else if (type === 'error') {
                    toast.classList.add('error');
                    toastIcon.classList.add('fas', 'fa-times-circle', 'text-xl');
                } else if (type === 'info') {
                    toast.classList.remove('success', 'error'); 
                    toastIcon.classList.add('fas', 'fa-spinner', 'fa-spin', 'text-xl');
                }

                if (duration > 0) {
                    toastTimeoutId = setTimeout(() => {
                        toast.classList.remove('show');
                        toastTimeoutId = null;
                    }, duration);
                }
            };
            
            const getCollectionName = (type) => {
                if (type === 'category') return 'categories';
                if (type === 'comment') return 'comments';
                if (type === 'reviewComment') return 'reviewComments';
                return `${type}s`; // Works for 'product' -> 'products', 'review' -> 'reviews'
            }

            // --- Modal Setup ---
            function setupModal(modalId, openBtnIds, closeBtnClass, oncloseCallback) {
                const modal = document.getElementById(modalId);
                if (!modal) return { modal: null, open: () => {}, close: () => {} };

                const open = () => {
                    modal.classList.add('visible');
                    modal.classList.remove('invisible', 'opacity-0');
                    document.body.style.overflow = 'hidden';
                };
                const close = () => {
                    modal.classList.add('invisible', 'opacity-0');
                    modal.classList.remove('visible');
                    document.body.style.overflow = '';
                    if (oncloseCallback) {
                        oncloseCallback();
                    }
                };
                
                openBtnIds.forEach(btnId => {
                    const openBtn = document.getElementById(btnId);
                    openBtn?.addEventListener('click', () => {
                        if (modalId === 'review-modal' && !currentUser) {
                            showToast('يجب تسجيل الدخول أولاً لإضافة رأيك', 'error');
                            loginModal.open();
                        } else {
                            open();
                        }
                    });
                });

                modal.querySelectorAll(closeBtnClass).forEach(btn => btn.addEventListener('click', close));
                modal.addEventListener('click', (e) => { if (e.target === modal) close(); });
                document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && modal.classList.contains('visible')) close(); });
                
                return { modal, open, close };
            }

            function initializeModals() {
                 loginModal = setupModal('login-modal', ['login-btn', 'mobile-login-btn', 'mobile-header-login-btn'], '.close-modal-btn');
                 signupModal = setupModal('signup-modal', ['signup-btn', 'mobile-signup-btn', 'mobile-header-signup-btn'], '.close-modal-btn');
                 profileModal = setupModal('profile-modal', ['edit-profile-btn', 'mobile-edit-profile-btn', 'mobile-header-edit-profile-btn'], '.close-modal-btn');
                 reviewModal = setupModal('review-modal', ['add-review-btn'], '.close-review-modal', resetReviewModal);
                 addCategoryModal = setupModal('add-category-modal', [], '.close-modal-btn');
                 addProductModal = setupModal('add-product-modal', [], '.close-modal-btn');
                 imageModal = setupModal('image-modal', [], '.close-modal');
                 editItemModal = setupModal('edit-item-modal', [], '.close-modal-btn');
                 confirmModal = setupModal('confirm-modal', [], '#confirm-modal-cancel-btn');
                 adminPassModal = setupModal('admin-pass-modal', [], '#cancel-admin-pass-btn');
                 commentsModal = setupModal('comments-modal', [], '.close-modal-btn', () => {
                    if (unsubscribeComments) unsubscribeComments();
                 });
                 cartModal = setupModal('cart-modal', ['cart-button'], '.close-modal-btn');
            }


            // --- Logic to switch between Login and Signup modals ---
            document.getElementById('switch-to-signup').addEventListener('click', (e) => {
                e.preventDefault();
                loginModal.close();
                signupModal.open();
            });

            document.getElementById('switch-to-login').addEventListener('click', (e) => {
                e.preventDefault();
                signupModal.close();
                loginModal.open();
            });


            // --- Firebase Auth State Listener ---
            onAuthStateChanged(auth, async (user) => {
                if (unsubscribeCategories) unsubscribeCategories();
                if (unsubscribeProducts) unsubscribeProducts();
                if (unsubscribeReviews) unsubscribeReviews();
                Object.values(activeReviewCommentListeners).forEach(unsub => unsub());
                activeReviewCommentListeners = {};
                
                if (user) {
                    const userDocRef = doc(db, "users", user.uid);
                    const docSnap = await getDoc(userDocRef);

                    if (docSnap.exists()) {
                        currentUser = { uid: user.uid, ...docSnap.data() };
                        updateUIAfterLogin();
                        showToast(`أهلاً بعودتك, ${currentUser.name}!`, 'success');
                    } else { 
                        currentUser = { uid: user.uid, email: user.email, name: 'مستخدم جديد', role: 'visitor', imageUrl: ''};
                        showToast('مرحباً بك!', 'success');
                    }
                } else {
                    currentUser = null;
                    updateUIAfterLogout();
                }
                
                // Fetch and render content for everyone
                listenToCategories();
                listenToReviews();
            });
            
            function updateUIAfterLogin() {
                // Desktop header
                guestLinks.classList.add('hidden');
                userProfileDisplay.classList.remove('hidden');
                userProfileDisplay.classList.add('flex');
                userNameDisplay.textContent = currentUser.name;
                userAvatarDisplay.src = currentUser.imageUrl || `https://placehold.co/40x40/8B4513/FFFFFF?text=${(currentUser.name || 'U').charAt(0).toUpperCase()}`;

                // Mobile side menu
                mobileGuestLinks.classList.add('hidden');
                mobileUserLinks.classList.remove('hidden');

                // Mobile header bar
                const mobileHeaderUserDisplay = document.getElementById('mobile-header-user-display');
                const mobileHeaderGuestLinks = document.getElementById('mobile-header-guest-links');
                const mobileHeaderUserNameDisplay = document.getElementById('mobile-header-user-name-display');
                const mobileHeaderUserAvatarDisplay = document.getElementById('mobile-header-user-avatar-display');
                
                mobileHeaderGuestLinks.classList.add('hidden');
                mobileHeaderUserDisplay.classList.remove('hidden');
                mobileHeaderUserDisplay.classList.add('flex');
                
                const userRoleText = currentUser.role === 'admin' ? ' (مسؤول)' : '';
                mobileHeaderUserNameDisplay.textContent = currentUser.name + userRoleText;
                mobileHeaderUserAvatarDisplay.src = currentUser.imageUrl || `https://placehold.co/40x40/8B4513/FFFFFF?text=${(currentUser.name || 'U').charAt(0).toUpperCase()}`;
                
                const profileForm = document.getElementById('profile-form');
                profileForm.querySelector('#profile-name').value = currentUser.name || '';
                profileForm.querySelector('#profile-phone').value = currentUser.phone || '';
                profileForm.querySelector('#profile-birthdate').value = currentUser.birthdate || '';
                profileForm.querySelector('#profile-email').value = currentUser.email || '';
                profileForm.querySelector('#profile-address').value = currentUser.address || '';
                profileForm.querySelector('#profile-image-preview').src = currentUser.imageUrl || 'https://placehold.co/80x80/EADDCA/5C4033?text=تغيير';

                document.getElementById('edit-hero-image-btn').classList.toggle('hidden', currentUser.role !== 'admin');

                loginModal.close();
                signupModal.close();
            }
        
            function updateUIAfterLogout() {
                // Desktop header
                guestLinks.classList.remove('hidden');
                guestLinks.classList.add('flex');
                userProfileDisplay.classList.add('hidden');
                userProfileDisplay.classList.remove('flex');
                
                // Mobile side menu
                mobileGuestLinks.classList.remove('hidden');
                mobileUserLinks.classList.add('hidden');

                // Mobile header bar
                const mobileHeaderUserDisplay = document.getElementById('mobile-header-user-display');
                const mobileHeaderGuestLinks = document.getElementById('mobile-header-guest-links');

                mobileHeaderGuestLinks.classList.remove('hidden');
                mobileHeaderGuestLinks.classList.add('flex');
                mobileHeaderUserDisplay.classList.add('hidden');
                mobileHeaderUserDisplay.classList.remove('flex');

                document.getElementById('edit-hero-image-btn').classList.add('hidden');
                
                // Re-fetch data to update admin-only views
                listenToCategories(); 
                listenToReviews();
            }

            function askForAdminPassword() {
                adminPassModal.open();
                const adminPassForm = document.getElementById('admin-pass-form');
                const adminPassInput = document.getElementById('admin-pass-input');
                adminPassInput.focus();
                adminPassInput.value = '';

                return new Promise((resolve, reject) => {
                    adminPassForm.onsubmit = (e) => {
                        e.preventDefault();
                        const password = adminPassInput.value;
                        adminPassModal.close();
                        resolve(password);
                    };

                    document.getElementById('cancel-admin-pass-btn').onclick = () => {
                         adminPassModal.close();
                         reject('Password entry cancelled');
                    }
                });
            }

            // --- Sign Up Logic ---
            const signupForm = document.getElementById('signup-form');
            signupForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const name = signupForm.querySelector('#signup-name').value;
                const email = signupForm.querySelector('#signup-email').value;
                const password = signupForm.querySelector('#signup-password').value;
                const phone = signupForm.querySelector('#signup-phone').value;
                const birthdate = signupForm.querySelector('#signup-birthdate').value;
                const address = signupForm.querySelector('#signup-address').value;
                const accountType = signupForm.querySelector('input[name="accountType"]:checked').value;
                const imageFile = signupForm.querySelector('#signup-image-input').files[0];

                if (accountType === 'admin') {
                    try {
                        const adminPass = await askForAdminPassword();
                        if (adminPass !== '334411') {
                            showToast('كلمة مرور المسؤول غير صحيحة.', 'error');
                            return;
                        }
                    } catch (error) {
                        showToast('تم إلغاء عملية التسجيل.', 'error');
                        return;
                    }
                }

                if (!birthdate) {
                    showToast('من فضلك أدخل تاريخ ميلادك.', 'error');
                    return;
                }

                showToast('جاري إنشاء الحساب...', 'info', 0);

                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    
                    let imageUrl = '';
                    if (imageFile) {
                        imageUrl = await compressAndEncodeImage(imageFile);
                    }

                    await setDoc(doc(db, "users", user.uid), {
                        name: name,
                        email: email,
                        phone: phone,
                        birthdate: birthdate,
                        address: address,
                        imageUrl: imageUrl,
                        role: accountType,
                        createdAt: serverTimestamp()
                    });
                    
                    signupForm.reset();
                    document.getElementById('signup-image-preview').src = 'https://placehold.co/80x80/EADDCA/5C4033?text=اختيار';
                } catch (error) {
                    console.error("Signup error:", error.code, error.message);
                    if (error.code === 'auth/email-already-in-use') {
                        showToast('هذا البريد الإلكتروني مستخدم بالفعل.', 'error');
                    } else if (error.code === 'auth/weak-password') {
                         showToast('كلمة المرور يجب أن تكون 6 أحرف على الأقل.', 'error');
                    } else {
                        showToast('حدث خطأ ما، يرجى المحاولة مرة أخرى.', 'error');
                    }
                }
            });
            

            // --- Login Logic ---
            const loginForm = document.getElementById('login-form');
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = loginForm.querySelector('#login-email').value;
                const password = loginForm.querySelector('#login-password').value;
                
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    console.error("Login error:", error.code, error.message);
                    showToast('البريد الإلكتروني أو كلمة المرور غير صحيحة.', 'error');
                }
            });

            // --- Logout Logic ---
            function handleLogout() {
                signOut(auth).then(() => {
                    showToast('تم تسجيل الخروج بنجاح.');
                }).catch((error) => {
                    console.error('Logout Error:', error);
                    showToast('حدث خطأ أثناء تسجيل الخروج.', 'error');
                });
            }
            [ 'logout-btn', 'mobile-logout-btn', 'mobile-header-logout-btn' ].forEach(id => {
                document.getElementById(id)?.addEventListener('click', handleLogout);
            });


            // --- Profile Update Logic ---
            const profileForm = document.getElementById('profile-form');
            profileForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentUser) return;
                
                showToast('جاري حفظ التعديلات...', 'info', 0);

                const newName = document.getElementById('profile-name').value;
                const newPhone = document.getElementById('profile-phone').value;
                const newAddress = document.getElementById('profile-address').value;
                const newImageFile = document.getElementById('profile-image-input').files[0];
                
                try {
                    const userDocRef = doc(db, "users", currentUser.uid);
                    const updateData = { name: newName, phone: newPhone, address: newAddress };
                    if (newImageFile) {
                        updateData.imageUrl = await compressAndEncodeImage(newImageFile);
                    }
                    
                    await updateDoc(userDocRef, updateData);
                    
                    currentUser = { ...currentUser, ...updateData };
                    
                    if (updateData.imageUrl) {
                        // TODO: Update user image in their comments/reviews via a Cloud Function
                    }
                    
                    showToast('تم تحديث البيانات بنجاح!', 'success');
                    updateUIAfterLogin();
                    profileModal.close();
                } catch(error) {
                    console.error("Error updating profile:", error);
                    showToast('حدث خطأ أثناء التحديث.', 'error');
                }
            });
           
            document.getElementById('signup-image-input').addEventListener('change', (e) => {
                if (e.target.files[0]) {
                    document.getElementById('signup-image-preview').src = URL.createObjectURL(e.target.files[0]);
                }
            });
            document.getElementById('profile-image-input').addEventListener('change', (e) => {
                if (e.target.files[0]) {
                    document.getElementById('profile-image-preview').src = URL.createObjectURL(e.target.files[0]);
                }
            });

            // --- Firestore Data Listeners & Renderers ---
            function listenToCategories() {
                const q = query(collection(db, "categories"));
                unsubscribeCategories = onSnapshot(q, (querySnapshot) => {
                    const categoriesData = [];
                    querySnapshot.forEach((doc) => {
                        categoriesData.push({ id: doc.id, ...doc.data() });
                    });
                    renderCategoriesView(categoriesData);
                }, (error) => {
                     console.error("Error fetching categories: ", error);
                     document.getElementById('products-display-area').innerHTML = '<p class="text-center text-red-500">حدث خطأ في تحميل الأقسام.</p>';
                });
            }

            function renderCategoriesView(categoriesData) {
                const displayArea = document.getElementById('products-display-area');
                if (!displayArea) return;
                
                displayArea.innerHTML = ''; 
                const categoryGrid = document.createElement('div');
                categoryGrid.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8';

                 if (categoriesData.length === 0) {
                     categoryGrid.innerHTML = `<p class="text-center text-gray-500 col-span-full py-8">لا توجد أقسام متاحة حالياً. ${currentUser?.role === 'admin' ? 'يمكنك إضافة قسم جديد من الزر أدناه.' : ''}</p>`;
                } else {
                    categoriesData.forEach(cat => {
                        const card = document.createElement('div');
                        card.className = 'category-card fade-in-up';
                        
                        const imagesToDisplay = cat.images?.slice(0, 6) || [];
                        const imageCount = imagesToDisplay.length;

                        const imagesHTML = imagesToDisplay.map(img => `<img src="${img}" alt="${cat.name}" loading="lazy" onerror="this.onerror=null;this.src='https://placehold.co/400x400/8B4513/FFFFFF?text=ThatAlNiqab';">`).join('');
                        
                        card.innerHTML = `
                            <a class="category-card-link">
                                <div class="image-container" data-image-count="${imageCount > 0 ? imageCount : 1}">
                                    ${imageCount > 0 ? imagesHTML : `<img src="https://placehold.co/800x600/EADDCA/5C4033?text=${encodeURIComponent(cat.name)}" alt="${cat.name}">`}
                                </div>
                            </a>
                            <div class="title-overlay">
                                <h3>${cat.name}</h3>
                                ${currentUser?.role === 'admin' ? `
                                <div class="admin-actions">
                                    <button class="action-btn edit-btn" title="تعديل القسم"><i class="fas fa-edit"></i></button>
                                    <button class="action-btn delete-btn" title="حذف القسم"><i class="fas fa-trash-alt"></i></button>
                                </div>` : ''}
                            </div>
                        `;
                        
                        card.querySelector('.category-card-link').addEventListener('click', () => {
                           listenToProducts(cat.id, cat.name);
                        });
                        
                        if (currentUser?.role === 'admin') {
                            card.querySelector('.delete-btn').addEventListener('click', (e) => {
                                e.stopPropagation();
                                handleDelete('category', cat.id, cat.name);
                            });
                            card.querySelector('.edit-btn').addEventListener('click', (e) => {
                                e.stopPropagation();
                                openEditModal(cat, 'category');
                            });
                        }
                        categoryGrid.appendChild(card);
                        if (revealObserver) revealObserver.observe(card);
                    });
                }
                displayArea.appendChild(categoryGrid);
                
                if (currentUser?.role === 'admin') {
                    const addButtonContainer = document.createElement('div');
                    addButtonContainer.className = 'text-center mt-12';
                    addButtonContainer.innerHTML = `<button id="open-add-category-modal" class="btn"><i class="fas fa-plus mr-2"></i> إضافة قسم جديد</button>`;
                    displayArea.appendChild(addButtonContainer);
                    document.getElementById('open-add-category-modal').addEventListener('click', () => addCategoryModal.open());
                }
            }
            
            // --- تعديل: إضافة علامة تحميل عند فتح قسم ---
            function listenToProducts(categoryId, categoryName) {
                if (unsubscribeProducts) unsubscribeProducts();
                
                const displayArea = document.getElementById('products-display-area');
                displayArea.innerHTML = `
                    <div class="text-center p-16 text-secondary animate-fade-in">
                        <div class="lds-heart"><div></div></div>
                        <p class="mt-4 font-artistic text-2xl">جاري تحميل إبداعات قسم ${categoryName}...</p>
                    </div>
                `;
                
                document.getElementById('products').scrollIntoView({ behavior: 'smooth' });
                
                const q = query(collection(db, "products"), where("categoryId", "==", categoryId));
                
                // إضافة تأخير بسيط لضمان ظهور علامة التحميل بشكل واضح
                setTimeout(() => {
                    unsubscribeProducts = onSnapshot(q, (querySnapshot) => {
                        const productsData = [];
                        querySnapshot.forEach((doc) => {
                            productsData.push({ id: doc.id, ...doc.data() });
                        });
                        renderProductsView(categoryId, categoryName, productsData);
                    }, (error) => {
                        console.error("Error fetching products: ", error);
                        displayArea.innerHTML = '<p class="text-center text-red-500">حدث خطأ في تحميل المنتجات.</p>';
                    });
                }, 500);
            }
            
            function renderProductsView(categoryId, categoryName, productsData) {
                const displayArea = document.getElementById('products-display-area');
                displayArea.innerHTML = '';
                
                const headerDiv = document.createElement('div');
                headerDiv.className = 'flex justify-between items-center mb-8';
                headerDiv.innerHTML = `
                    <h4 class="font-artistic text-4xl">${categoryName}</h4>
                    <button id="back-to-categories-btn" class="btn btn-secondary"><i class="fas fa-arrow-right ml-2"></i> العودة للأقسام</button>
                `;
                displayArea.appendChild(headerDiv);
                document.getElementById('back-to-categories-btn').addEventListener('click', listenToCategories);
                
                const productsGrid = document.createElement('div');
                productsGrid.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8';

                if (productsData.length === 0) {
                    productsGrid.innerHTML = `<p class="text-center text-gray-500 col-span-full py-8">لا توجد منتجات في هذا القسم بعد. ${currentUser?.role === 'admin' ? 'يمكنك إضافة منتج جديد من الزر أدناه.' : ''}</p>`;
                } else {
                    productsData.forEach(p => {
                        const productEl = document.createElement('div');
                        productEl.className = 'product-card text-right fade-in-up';
                        productEl.id = `product-${p.id}`; // Add ID for easy targeting
                        
                        const imagesToDisplay = p.images || [];
                        const price = p.price || 0;
                        
                        const thumbnailsHTML = imagesToDisplay.map((imgSrc, index) => `
                            <img src="${imgSrc}" 
                                alt="صورة مصغرة ${index + 1} لـ ${p.name}" 
                                class="thumbnail w-16 h-16 object-cover flex-shrink-0 rounded-md ${index === 0 ? 'active-thumbnail' : ''}" 
                                data-index="${index}"
                                loading="lazy" 
                                onerror="this.onerror=null;this.src='https://placehold.co/100x100/EADDCA/5C4033?text=R';">
                        `).join('');
                        
                        const isLiked = currentUser && p.likedBy?.includes(currentUser.uid);

                        productEl.innerHTML = `
                            <div class="relative group">
                                <div class="image-container h-80 overflow-hidden cursor-pointer" title="اضغط لعرض الصورة بحجم أكبر">
                                    <img src="${imagesToDisplay[0] || 'https://placehold.co/400x400/8B4513/FFFFFF?text=ThatAlNiqab'}" alt="${p.name}" class="main-product-image w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" loading="lazy" onerror="this.onerror=null;this.src='https://placehold.co/400x400/8B4513/FFFFFF?text=ThatAlNiqab';">
                                </div>
                                ${currentUser?.role === 'admin' ? `
                                <div class="admin-actions">
                                    <button class="action-btn edit-btn" title="تعديل المنتج"><i class="fas fa-edit"></i></button>
                                    <button class="action-btn delete-btn" title="حذف المنتج"><i class="fas fa-trash-alt"></i></button>
                                </div>` : ''}
                            </div>
                            <div class="product-content">
                                <h3 class="text-xl font-artistic text-secondary mb-2">${p.name}</h3>
                                <div class="thumbnail-scroller mb-3">
                                    ${thumbnailsHTML}
                                </div>

                                <!-- Add Price and Cart controls -->
                                <div class="mt-auto pt-3 border-t border-border-light">
                                    <div class="flex justify-between items-center mb-3">
                                        <span class="font-bold text-lg text-primary-dark">${price} جنيه</span>
                                        <div class="flex items-center gap-2">
                                            <label for="qty-${p.id}" class="text-sm">الكمية:</label>
                                            <input type="number" id="qty-${p.id}" value="1" min="1" class="quantity-input w-16">
                                        </div>
                                    </div>
                                    <button class="btn w-full add-to-cart-btn" data-product-id="${p.id}" data-product-name="${p.name}" data-product-price="${price}" data-product-image="${imagesToDisplay[0] || ''}">
                                        <i class="fas fa-cart-plus mr-2"></i> إضافة للسلة
                                    </button>
                                </div>
                                
                                <div class="product-interactions mt-4">
                                    <button class="interaction-btn like-btn" data-product-id="${p.id}">
                                        <i class="fa-${isLiked ? 'solid' : 'regular'} fa-heart"></i>
                                        <span class="likes-count">${p.likesCount || 0}</span>
                                    </button>
                                    <button class="interaction-btn comment-btn" data-product-id="${p.id}" data-product-name="${p.name}">
                                        <i class="far fa-comment"></i>
                                        <span class="comments-count">${p.commentsCount || 0}</span>
                                    </button>
                                    <button class="interaction-btn share-btn" data-product-id="${p.id}" data-product-name="${p.name}">
                                        <i class="fas fa-share-alt"></i>
                                        <span>مشاركة</span>
                                    </button>
                                </div>
                            </div>
                        `;
                        
                        if (currentUser?.role === 'admin') {
                            productEl.querySelector('.delete-btn').addEventListener('click', (e) => {
                                e.stopPropagation();
                                handleDelete('product', p.id, p.name);
                            });
                            productEl.querySelector('.edit-btn').addEventListener('click', (e) => {
                                e.stopPropagation();
                                openEditModal(p, 'product');
                            });
                        }

                        const mainImage = productEl.querySelector('.main-product-image');
                        productEl.querySelector('.image-container').addEventListener('click', () => {
                            document.getElementById('modal-img').src = mainImage.src;
                            imageModal.open();
                        });

                        productEl.querySelectorAll('.thumbnail').forEach(thumb => {
                            thumb.addEventListener('click', (e) => {
                                e.stopPropagation();
                                productEl.querySelector('.active-thumbnail')?.classList.remove('active-thumbnail');
                                thumb.classList.add('active-thumbnail');
                                mainImage.src = thumb.src;
                            });
                        });

                        // Event listeners for interaction buttons
                        productEl.querySelector('.add-to-cart-btn').addEventListener('click', handleAddToCart);
                        productEl.querySelector('.like-btn').classList.toggle('liked', isLiked);
                        productEl.querySelector('.like-btn').addEventListener('click', handleLike);
                        productEl.querySelector('.comment-btn').addEventListener('click', handleCommentClick);
                        productEl.querySelector('.share-btn').addEventListener('click', handleShare);
                        
                        productsGrid.appendChild(productEl);
                        if (revealObserver) revealObserver.observe(productEl);
                    });
                }
                displayArea.appendChild(productsGrid);

                if (currentUser?.role === 'admin') {
                    const addButtonContainer = document.createElement('div');
                    addButtonContainer.className = 'text-center mt-8 col-span-full';
                    addButtonContainer.innerHTML = `<button id="open-add-product-modal" class="btn"><i class="fas fa-plus mr-2"></i> إضافة منتج جديد</button>`;
                    productsGrid.appendChild(addButtonContainer);
                    document.getElementById('open-add-product-modal').addEventListener('click', () => {
                        document.getElementById('product-category-id-input').value = categoryId;
                        addProductModal.open();
                    });
                }
            }
            
            function listenToReviews() {
                const q = query(collection(db, "reviews"));
                unsubscribeReviews = onSnapshot(q, (querySnapshot) => {
                    const grid = document.getElementById('testimonials-grid');
                    if (!grid) return;
                    grid.innerHTML = '';
                    
                    if (querySnapshot.empty) {
                         grid.innerHTML = '<p class="text-center text-gray-500 col-span-full py-8">كن أول من يشاركنا رأيه!</p>';
                         return;
                    }
                    
                    const reviewsData = [];
                    querySnapshot.forEach(doc => reviewsData.push({ id: doc.id, ...doc.data() }));
                    // Sort reviews to show newest first
                    reviewsData.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));

                    reviewsData.forEach(review => {
                        addTestimonialToPage(review);
                    });
                }, (error) => {
                     console.error("Error fetching reviews: ", error);
                     document.getElementById('testimonials-grid').innerHTML = '<p class="text-center text-red-500">حدث خطأ في تحميل الآراء.</p>';
                });
            }

            function addTestimonialToPage(review) {
                const testimonialsGrid = document.getElementById('testimonials-grid');
                if (!testimonialsGrid) return;

                const card = document.createElement('div');
                card.className = 'testimonial-card text-center fade-in-up';
                card.id = `review-${review.id}`;
                
                let starsHTML = '';
                for (let i = 0; i < 5; i++) {
                    starsHTML += `<i class="fas fa-star ${i < review.rating ? '' : 'text-gray-300'}"></i>`;
                }
                
                const canModify = currentUser && (currentUser.uid === review.userId || currentUser.role === 'admin');
                const isLiked = currentUser && review.likedBy?.includes(currentUser.uid);

                card.innerHTML = `
                    ${canModify ? `
                    <div class="admin-actions">
                        <button class="action-btn edit-btn" title="تعديل الرأي"><i class="fas fa-edit"></i></button>
                        <button class="action-btn delete-btn" title="حذف الرأي"><i class="fas fa-trash-alt"></i></button>
                    </div>` : ''}
                    <img src="${review.userImage || 'https://placehold.co/100x100/8B4513/FFFFFF?text=R'}" alt="صورة العميل ${review.userName}" class="testimonial-image" onerror="this.onerror=null;this.src='https://placehold.co/100x100/8B4513/FFFFFF?text=R';">
                    <h4 class="font-bold font-artistic text-secondary text-xl mt-2 mb-1">${review.userName}</h4>
                    <div class="stars mb-3">
                        ${starsHTML}
                    </div>
                    <p class="text-gray-600 italic leading-relaxed">"${review.comment}"</p>

                    <div class="review-interactions">
                        <button class="interaction-btn like-review-btn ${isLiked ? 'liked' : ''}" data-review-id="${review.id}">
                             <i class="fa-${isLiked ? 'solid' : 'regular'} fa-heart"></i>
                             <span class="likes-count">${review.likesCount || 0}</span>
                        </button>
                        <button class="interaction-btn comment-review-btn" data-review-id="${review.id}" data-review-author-id="${review.userId}">
                             <i class="far fa-comment"></i>
                             <span class="comments-count">${review.commentsCount || 0}</span>
                        </button>
                    </div>
                    <div class="review-comments-container hidden" id="comments-for-${review.id}">
                        <!-- Comments will be loaded here -->
                    </div>
                `;
                
                if(canModify) {
                    card.querySelector('.delete-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        handleDelete('review', review.id, `رأي المستخدم ${review.userName}`);
                    });
                    
                    card.querySelector('.edit-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (currentUser.uid === review.userId) {
                            openReviewEditModal(review);
                        } else {
                            showToast('يمكن للمسؤولين حذف آراء الآخرين فقط، وليس تعديلها.', 'error');
                        }
                    });
                }
                // Add event listeners for new interactions
                card.querySelector('.like-review-btn').addEventListener('click', handleReviewLike);
                card.querySelector('.comment-review-btn').addEventListener('click', toggleReviewComments);

                testimonialsGrid.appendChild(card);
                if (revealObserver) revealObserver.observe(card);
            }
            
            async function handleDelete(type, id, name) {
                try {
                    let confirmText = `هل أنت متأكد أنك تريد حذف "${name}"؟ هذا الإجراء لا يمكن التراجع عنه.`;
                    const relatedCollectionsToDelete = [];
                    if (type === 'category') {
                        confirmText = `هل أنت متأكد أنك تريد حذف قسم "${name}"؟ سيتم حذف كل المنتجات والتعليقات المرتبطة به أيضاً.`;
                        relatedCollectionsToDelete.push({coll: 'products', field: 'categoryId'});
                    } else if (type === 'product') {
                         relatedCollectionsToDelete.push({coll: 'comments', field: 'productId'});
                    } else if (type === 'review') {
                         relatedCollectionsToDelete.push({coll: 'reviewComments', field: 'reviewId'});
                    }

                    await showConfirmModal(confirmText);

                    // Cascade delete related items
                    for (const rel of relatedCollectionsToDelete) {
                        const q = query(collection(db, rel.coll), where(rel.field, "==", id));
                        const snapshot = await getDocs(q);
                        const deletePromises = snapshot.docs.map(docToDelete => deleteDoc(docToDelete.ref));
                        await Promise.all(deletePromises);
                    }
                    
                    await deleteDoc(doc(db, getCollectionName(type), id));
                    showToast(`تم حذف "${name}" بنجاح.`, 'success');

                } catch (err) {
                    if (err !== 'Cancelled') {
                        console.error(`Error deleting ${type}:`, err);
                        showToast(`فشل حذف "${name}".`, 'error');
                    }
                }
            }

            function initReviewModal() {
                if (!reviewModal.modal) return;
                
                const form = document.getElementById('review-form');
                const starWrapper = form.querySelector('.star-rating');
                const stars = form.querySelectorAll('.star-rating i');
                const ratingInput = document.getElementById('rating');

                document.getElementById('add-review-btn').addEventListener('click', () => {
                    if (currentUser) {
                        resetReviewModal();
                        document.getElementById('review-image-preview').src = currentUser.imageUrl || 'https://placehold.co/100x100/8B4513/FFFFFF?text=R';
                        document.getElementById('review-name-display').textContent = currentUser.name;
                    }
                });
                
                const setRating = (rating) => {
                    stars.forEach(star => {
                        const isSelected = star.dataset.value <= rating;
                        star.classList.toggle('fas', isSelected);
                        star.classList.toggle('far', !isSelected);
                        star.classList.toggle('selected', isSelected);
                    });
                }

                stars.forEach(star => {
                    star.addEventListener('mouseover', () => {
                        const hoverValue = star.dataset.value;
                        stars.forEach(s => {
                            const isHovered = s.dataset.value <= hoverValue;
                            s.classList.toggle('fas', isHovered);
                            s.classList.toggle('far', !isHovered);
                            s.classList.toggle('hovered', isHovered);
                        });
                    });
                    star.addEventListener('click', () => {
                        const rating = star.dataset.value;
                        ratingInput.value = rating;
                        starWrapper.dataset.rating = rating; 
                        setRating(rating);
                    });
                });

                starWrapper.addEventListener('mouseleave', () => {
                    stars.forEach(s => s.classList.remove('hovered'));
                    setRating(starWrapper.dataset.rating);
                });
                
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (ratingInput.value === '0') {
                        showToast('من فضلك اختر تقييمًا.', 'error'); return;
                    }
                    const reviewId = form.querySelector('#review-id-input').value;
                    const data = {
                        rating: parseInt(ratingInput.value, 10),
                        comment: form.querySelector('#review-comment').value,
                    };
                    try {
                        if (reviewId) {
                            await updateDoc(doc(db, 'reviews', reviewId), data);
                            showToast('تم تعديل رأيك بنجاح!', 'success');
                        } else {
                            data.userId = currentUser.uid;
                            data.userName = currentUser.name;
                            data.userImage = currentUser.imageUrl;
                            data.createdAt = serverTimestamp();
                            // Initialize interaction fields
                            data.likesCount = 0;
                            data.commentsCount = 0;
                            data.likedBy = [];
                            await addDoc(collection(db, 'reviews'), data);
                            showToast('شكرًا لمشاركتنا رأيك!', 'success');
                        }
                        reviewModal.close();
                    } catch (error) {
                         console.error("Error saving review:", error);
                         showToast('حدث خطأ أثناء حفظ الرأي.', 'error');
                    }
                });
            }

            function openReviewEditModal(review) {
                resetReviewModal();
                const form = document.getElementById('review-form');
                form.querySelector('#review-id-input').value = review.id;
                form.querySelector('#review-comment').value = review.comment;
                document.getElementById('review-image-preview').src = review.userImage || 'https://placehold.co/100x100/8B4513/FFFFFF?text=R';
                document.getElementById('review-name-display').textContent = review.userName;

                const rating = review.rating;
                const ratingInput = document.getElementById('rating');
                ratingInput.value = rating;
                const starWrapper = form.querySelector('.star-rating');
                starWrapper.dataset.rating = rating;
                starWrapper.querySelectorAll('i').forEach(star => {
                    const isSelected = star.dataset.value <= rating;
                    star.classList.toggle('selected', isSelected);
                    star.classList.toggle('fas', isSelected);
                    star.classList.toggle('far', !isSelected);
                });
                
                document.getElementById('review-modal-title').textContent = "تعديل الرأي";
                form.querySelector('button[type="submit"]').innerHTML = 'حفظ التعديلات <i class="fas fa-save mr-2"></i>';
                reviewModal.open();
            }
            
            function resetReviewModal() {
                const form = document.getElementById('review-form');
                form.reset();
                form.querySelector('#review-id-input').value = '';
                document.getElementById('review-name-display').textContent = '';
                const starWrapper = form.querySelector('.star-rating');
                starWrapper.dataset.rating = '0';
                document.getElementById('rating').value = '0';
                starWrapper.querySelectorAll('i').forEach(star => {
                    star.classList.remove('selected', 'fas');
                    star.classList.add('far');
                });
                document.getElementById('review-modal-title').textContent = "شاركنا رأيك";
                form.querySelector('button[type="submit"]').innerHTML = 'إرسال الرأي <i class="fas fa-check mr-2"></i>';
            }

            function handleMultiImagePreview(inputId, previewDivId) {
                 const input = document.getElementById(inputId);
                 const previewDiv = document.getElementById(previewDivId);
                 input.addEventListener('change', () => {
                     previewDiv.innerHTML = ''; 
                     if (input.files.length === 0) return;
                     Array.from(input.files).forEach(file => {
                         const thumbWrapper = document.createElement('div');
                         thumbWrapper.className = 'image-preview-thumb-wrapper';
                         thumbWrapper.innerHTML = `<img src="${URL.createObjectURL(file)}" class="image-preview-thumb">`;
                         previewDiv.appendChild(thumbWrapper);
                     });
                 });
            }

            
            async function handleItemFormSubmit(e, type) {
                e.preventDefault();
                const form = e.target;
                const name = form.querySelector('input[type="text"]').value.trim();
                const price = form.querySelector('input[type="number"]')?.value;
                const imageFiles = form.querySelector('input[type="file"]').files;
                const categoryId = form.querySelector('#product-category-id-input')?.value;

                if (!name || (type === 'category' && imageFiles.length === 0)) {
                    showToast('يرجى إدخال الاسم واختيار صورة واحدة على الأقل.', 'error'); 
                    return;
                }
                if (type === 'product' && !price) {
                     showToast('يرجى إدخال سعر المنتج.', 'error'); 
                    return;
                }
                
                showToast(`جاري ضغط الصور وحفظ ${type === 'category' ? 'القسم' : 'المنتج'}...`, 'info', 0);

                try {
                    const imageUrls = await Promise.all(Array.from(imageFiles).map(file => compressAndEncodeImage(file)));
                
                    const data = { name, images: imageUrls, createdAt: serverTimestamp() };
                    if (type === 'product') {
                        data.categoryId = categoryId;
                        data.price = parseFloat(price);
                        data.likesCount = 0;
                        data.commentsCount = 0;
                        data.likedBy = [];
                    }
                    
                    await addDoc(collection(db, getCollectionName(type)), data);
                    
                    showToast(`تم حفظ ${type === 'category' ? 'القسم' : 'المنتج'} بنجاح!`, 'success');
                    form.reset();
                    form.querySelector('div[id$="-preview"]').innerHTML = '';
                    if (type === 'category') addCategoryModal.close();
                    if (type === 'product') addProductModal.close();

                } catch (error) {
                    console.error(`Error saving ${type}:`, error);
                    showToast('حدث خطأ أثناء الحفظ.', 'error');
                }
            }
            
            function openEditModal(item, type) {
                const form = document.getElementById('edit-item-form');
                form.reset();
                const imagesPreviewDiv = document.getElementById('edit-item-images-preview');
                const priceContainer = document.getElementById('edit-item-price-container');
                imagesPreviewDiv.innerHTML = '';
                
                document.getElementById('edit-item-modal-title').textContent = type === 'category' ? 'تعديل القسم' : 'تعديل المنتج';
                document.getElementById('edit-item-name-input').value = item.name;
                document.getElementById('edit-item-id-input').value = item.id;
                document.getElementById('edit-item-type-input').value = type;

                if(type === 'product') {
                    document.getElementById('edit-item-category-id-input').value = item.categoryId;
                    document.getElementById('edit-item-price-input').value = item.price || 0;
                    priceContainer.classList.remove('hidden');
                } else {
                    priceContainer.classList.add('hidden');
                }

                let currentImages = [...(item.images || [])];
                
                function renderImagePreviews() {
                    imagesPreviewDiv.innerHTML = '';
                    currentImages.forEach((imgSrc, index) => {
                        const thumbWrapper = document.createElement('div');
                        thumbWrapper.className = 'image-preview-thumb-wrapper';
                        thumbWrapper.innerHTML = `
                            <img src="${imgSrc}" class="image-preview-thumb">
                            <button type="button" class="delete-image-btn" data-index="${index}" title="حذف الصورة">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                        imagesPreviewDiv.appendChild(thumbWrapper);
                    });

                    imagesPreviewDiv.querySelectorAll('.delete-image-btn').forEach(btn => {
                        btn.onclick = () => {
                            currentImages.splice(parseInt(btn.dataset.index), 1);
                            renderImagePreviews();
                        };
                    });
                }
                
                renderImagePreviews();

                document.getElementById('edit-item-images-input').onchange = async () => {
                    const newFiles = Array.from(document.getElementById('edit-item-images-input').files);
                    showToast('جاري ضغط الصور الجديدة...', 'success');
                    const newImageUrls = await Promise.all(newFiles.map(file => compressAndEncodeImage(file)));
                    currentImages.push(...newImageUrls);
                    renderImagePreviews();
                    document.getElementById('edit-item-images-input').value = ''; 
                };
                
                form.onsubmit = async (e) => {
                    e.preventDefault();
                    const id = document.getElementById('edit-item-id-input').value;
                    const newName = document.getElementById('edit-item-name-input').value.trim();
                    const newPrice = document.getElementById('edit-item-price-input').value;

                    if (!newName) { showToast('الاسم لا يمكن أن يكون فارغاً.', 'error'); return; }

                    try {
                        const itemRef = doc(db, getCollectionName(type), id);
                        const updateData = { name: newName, images: currentImages };
                        if (type === 'product') {
                            updateData.price = parseFloat(newPrice);
                        }
                        await updateDoc(itemRef, updateData);
                        showToast('تم حفظ التعديلات بنجاح!', 'success');
                        editItemModal.close();
                    } catch (error) {
                        console.error(`Error updating ${type}:`, error);
                        showToast('فشل حفظ التعديلات.', 'error');
                    }
                };
                editItemModal.open();
            }
            
            function showConfirmModal(text, confirmBtnText = 'تأكيد الحذف', confirmBtnClass = '!bg-red-500') {
                document.getElementById('confirm-modal-text').textContent = text;
                const confirmBtn = document.getElementById('confirm-modal-confirm-btn');
                confirmBtn.textContent = confirmBtnText;
                confirmBtn.className = `btn ${confirmBtnClass}`;

                confirmModal.open();
                return new Promise((resolve, reject) => {
                    confirmBtn.onclick = () => { confirmModal.close(); resolve(); };
                    document.getElementById('confirm-modal-cancel-btn').onclick = () => { confirmModal.close(); reject('Cancelled'); };
                });
            }
            
            // --- Product Interactions ---
            async function handleLike(event) {
                if (!currentUser) {
                    showToast('يجب تسجيل الدخول أولاً للإعجاب بالمنتجات', 'error');
                    loginModal.open();
                    return;
                }
                const button = event.currentTarget;
                const productId = button.dataset.productId;
                const productRef = doc(db, 'products', productId);

                try {
                    await runTransaction(db, async (transaction) => {
                        const productDoc = await transaction.get(productRef);
                        if (!productDoc.exists()) throw "Product does not exist!";
                        
                        const likedBy = productDoc.data().likedBy || [];
                        const isLiked = likedBy.includes(currentUser.uid);
                        
                        transaction.update(productRef, {
                            likedBy: isLiked ? arrayRemove(currentUser.uid) : arrayUnion(currentUser.uid),
                            likesCount: increment(isLiked ? -1 : 1)
                        });
                    });
                } catch (error) {
                    console.error("Like transaction failed: ", error);
                    showToast("حدث خطأ ما.", "error");
                }
            }
            
            function handleCommentClick(event) {
                if (!currentUser) {
                    showToast('يجب تسجيل الدخول أولاً للتعليق', 'error');
                    loginModal.open();
                    return;
                }
                const button = event.currentTarget;
                const productId = button.dataset.productId;
                const productName = button.dataset.productName;

                document.getElementById('comments-modal-title').textContent = `تعليقات على "${productName}"`;
                document.getElementById('comment-product-id-input').value = productId;
                listenToComments(productId);
                commentsModal.open();
            }
            
            function listenToComments(productId) {
                if (unsubscribeComments) unsubscribeComments();
                
                const q = query(collection(db, "comments"), where("productId", "==", productId));
                const commentsList = document.getElementById('comments-list');
                
                unsubscribeComments = onSnapshot(q, (snapshot) => {
                    const allComments = [];
                    snapshot.forEach(doc => allComments.push({ id: doc.id, ...doc.data() }));
                    
                    allComments.sort((a, b) => (a.createdAt?.toMillis() || 0) - (b.createdAt?.toMillis() || 0));
                    
                    const topLevelComments = allComments.filter(c => !c.parentCommentId);
                    const replies = allComments.filter(c => c.parentCommentId);

                    if (allComments.length === 0) {
                        commentsList.innerHTML = `<p class="text-center text-gray-500 py-8">لا توجد تعليقات بعد. كن أول من يكتب تعليقاً!</p>`;
                        return;
                    }

                    commentsList.innerHTML = topLevelComments.map(comment => renderComment(comment, replies)).join('');
                    
                    commentsList.querySelectorAll('.reply-btn').forEach(btn => btn.addEventListener('click', showReplyForm));
                    commentsList.querySelectorAll('.delete-comment-btn').forEach(btn => btn.addEventListener('click', (e) => handleDeleteComment(e, 'comments')));
                }, (error) => {
                    console.error("Error listening to comments:", error);
                    commentsList.innerHTML = `<p class="text-center text-red-500 py-8">حدث خطأ في تحميل التعليقات.</p>`;
                });
            }
            
            function renderComment(comment, allReplies) {
                const commentReplies = allReplies.filter(r => r.parentCommentId === comment.id);
                const canDelete = currentUser && (currentUser.uid === comment.userId || currentUser.role === 'admin');
                const timeAgo = comment.createdAt ? timeSince(comment.createdAt.toDate()) : 'الآن';

                return `
                    <div class="comment-item">
                        <img src="${comment.userImage || 'https://placehold.co/40x40/8B4513/FFFFFF?text=R'}" alt="${comment.userName}" class="comment-avatar">
                        <div class="comment-body">
                            <div class="comment-header">
                                <span class="comment-user">${comment.userName}</span>
                                <span class="comment-timestamp">${timeAgo}</span>
                            </div>
                            <p class="comment-text">${comment.text.replace(/\n/g, '<br>')}</p>
                            <div class="comment-actions">
                                <button class="comment-action-btn reply-btn" data-comment-id="${comment.id}">رد</button>
                                ${canDelete ? `<button class="comment-action-btn text-red-500 delete-comment-btn" data-comment-id="${comment.id}">حذف</button>` : ''}
                            </div>
                            <div class="reply-form-container hidden"></div>
                            ${commentReplies.length > 0 ? `<div class="comment-replies">${commentReplies.map(reply => renderComment(reply, allReplies)).join('')}</div>` : ''}
                        </div>
                    </div>
                `;
            }

            document.getElementById('add-comment-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const productId = form.querySelector('#comment-product-id-input').value;
                const textInput = form.querySelector('#new-comment-input');
                const text = textInput.value.trim();

                if (!text || !productId || !currentUser) return;
                
                try {
                    await runTransaction(db, async (transaction) => {
                        const productRef = doc(db, "products", productId);
                        transaction.update(productRef, { commentsCount: increment(1) });
                        
                        const commentsRef = collection(db, "comments");
                        transaction.set(doc(commentsRef), {
                            productId,
                            userId: currentUser.uid,
                            userName: currentUser.name,
                            userImage: currentUser.imageUrl || '',
                            text,
                            createdAt: serverTimestamp(),
                            parentCommentId: null,
                        });
                    });
                    textInput.value = '';
                } catch(error) {
                    console.error("Error adding comment: ", error);
                    showToast("حدث خطأ أثناء إضافة التعليق.", "error");
                }
            });
            
            async function handleDeleteComment(event, collectionName) {
                const button = event.currentTarget;
                const commentId = button.dataset.commentId;
                if(!commentId) return;

                try {
                    await showConfirmModal("هل أنت متأكد من حذف هذا التعليق؟");
                    
                    const commentRef = doc(db, collectionName, commentId);
                    const commentDoc = await getDoc(commentRef);
                    if(!commentDoc.exists()) return;

                    const commentData = commentDoc.data();
                    const parentRef = doc(db, collectionName === 'comments' ? 'products' : 'reviews', collectionName === 'comments' ? commentData.productId : commentData.reviewId);
                    
                    await runTransaction(db, async (transaction) => {
                        transaction.update(parentRef, { commentsCount: increment(-1) });
                        transaction.delete(commentRef);
                        // Future improvement: Cloud Function to delete replies.
                    });
                    showToast("تم حذف التعليق.", "success");
                } catch(error) {
                    if (error !== 'Cancelled') {
                        console.error("Error deleting comment: ", error);
                        showToast("فشل حذف التعليق.", "error");
                    }
                }
            }

            function showReplyForm(event) {
                document.querySelectorAll('.reply-form-container').forEach(c => c.innerHTML = '');

                const button = event.currentTarget;
                const container = button.closest('.comment-body').querySelector('.reply-form-container');
                container.innerHTML = `
                    <form class="reply-form" data-parent-id="${button.dataset.commentId}">
                        <input type="text" class="reply-input form-input !py-2" placeholder="اكتب ردك..." required>
                        <button type="submit" class="btn !rounded-lg !px-4 !py-2">رد</button>
                    </form>
                `;
                container.querySelector('.reply-form').addEventListener('submit', handleReplySubmit);
                container.classList.remove('hidden');
                container.querySelector('input').focus();
            }
            
            async function handleReplySubmit(event) {
                event.preventDefault();
                const form = event.currentTarget;
                const parentId = form.dataset.parentId;
                const productId = document.getElementById('comment-product-id-input').value;
                const textInput = form.querySelector('.reply-input');
                const text = textInput.value.trim();
                
                if (!text || !parentId || !productId || !currentUser) return;
                
                try {
                     await runTransaction(db, async (transaction) => {
                        const productRef = doc(db, "products", productId);
                        transaction.update(productRef, { commentsCount: increment(1) });
                        
                        const commentsRef = collection(db, "comments");
                        transaction.set(doc(commentsRef), {
                            productId,
                            userId: currentUser.uid,
                            userName: currentUser.name,
                            userImage: currentUser.imageUrl || '',
                            text,
                            createdAt: serverTimestamp(),
                            parentCommentId: parentId,
                        });
                    });
                    form.parentElement.innerHTML = '';
                } catch(error) {
                    console.error("Error adding reply: ", error);
                    showToast("حدث خطأ أثناء إضافة الرد.", "error");
                }
            }

            async function handleShare(event) {
                const button = event.currentTarget;
                const productName = button.dataset.productName;
                const pageUrl = window.location.href;

                try {
                    if (navigator.share) {
                        await navigator.share({
                            title: `منتج من ذات النقاب : ${productName}`,
                            text: `لقد أعجبني هذا المنتج "${productName}" من ذات النقاب !`,
                            url: pageUrl,
                        });
                    } else {
                        await navigator.clipboard.writeText(pageUrl);
                        showToast('تم نسخ رابط المنتج! يمكنك لصقه ومشاركته.', 'success');
                    }
                } catch (err) {
                    console.error("Share failed:", err);
                }
            }

            // --- Review Interactions ---
            async function handleReviewLike(event) {
                if (!currentUser) {
                    showToast('يجب تسجيل الدخول أولاً', 'error');
                    loginModal.open();
                    return;
                }
                const button = event.currentTarget;
                const reviewId = button.dataset.reviewId;
                const reviewRef = doc(db, 'reviews', reviewId);

                try {
                    await runTransaction(db, async (transaction) => {
                        const reviewDoc = await transaction.get(reviewRef);
                        if (!reviewDoc.exists()) throw "Review does not exist!";
                        
                        const likedBy = reviewDoc.data().likedBy || [];
                        const isLiked = likedBy.includes(currentUser.uid);
                        
                        transaction.update(reviewRef, {
                            likedBy: isLiked ? arrayRemove(currentUser.uid) : arrayUnion(currentUser.uid),
                            likesCount: increment(isLiked ? -1 : 1)
                        });
                    });
                } catch (error) {
                    console.error("Review like transaction failed: ", error);
                    showToast("حدث خطأ ما.", "error");
                }
            }
            
            function toggleReviewComments(event) {
                if (!currentUser) {
                    showToast('يجب تسجيل الدخول أولاً لرؤية التعليقات.', 'error');
                    loginModal.open();
                    return;
                }
                const button = event.currentTarget;
                const reviewId = button.dataset.reviewId;
                const reviewAuthorId = button.dataset.reviewAuthorId;
                const container = document.getElementById(`comments-for-${reviewId}`);

                if (container.classList.toggle('hidden')) {
                    // If we are hiding it, unsubscribe
                    if (activeReviewCommentListeners[reviewId]) {
                        activeReviewCommentListeners[reviewId]();
                        delete activeReviewCommentListeners[reviewId];
                    }
                } else {
                    // If we are showing it, load the comments
                    loadReviewComments(reviewId, container, reviewAuthorId);
                }
            }

            function loadReviewComments(reviewId, container, reviewAuthorId) {
                container.innerHTML = `<div class="text-center p-4"><i class="fas fa-spinner fa-spin"></i></div>`;

                if (activeReviewCommentListeners[reviewId]) {
                    activeReviewCommentListeners[reviewId]();
                }

                const q = query(collection(db, "reviewComments"), where("reviewId", "==", reviewId));
                activeReviewCommentListeners[reviewId] = onSnapshot(q, (snapshot) => {
                    let contentHTML = '';
                    if (snapshot.empty) {
                        contentHTML = '<p class="text-center text-gray-500 text-sm pb-2">لا توجد ردود بعد.</p>';
                    } else {
                        const comments = [];
                        snapshot.forEach(doc => comments.push({ id: doc.id, ...doc.data() }));
                        comments.sort((a, b) => (a.createdAt?.toMillis() || 0) - (b.createdAt?.toMillis() || 0));
                        contentHTML = comments.map(renderReviewComment).join('');
                    }

                    const canComment = currentUser && (currentUser.uid === reviewAuthorId || currentUser.role === 'admin');
                    if (canComment) {
                        contentHTML += `
                            <form class="add-review-comment-form mt-4" data-review-id="${reviewId}">
                                <textarea class="form-textarea !py-2 !text-sm" rows="2" placeholder="اكتب ردك هنا..." required></textarea>
                                <button type="submit" class="btn !rounded-lg !px-4 !py-1 !text-sm mt-2">إرسال الرد</button>
                            </form>
                        `;
                    }
                    
                    container.innerHTML = contentHTML;
                    container.querySelectorAll('.add-review-comment-form').forEach(form => form.addEventListener('submit', handleReviewCommentSubmit));
                    container.querySelectorAll('.delete-comment-btn').forEach(btn => btn.addEventListener('click', (e) => handleDeleteComment(e, 'reviewComments')));
                });
            }

            function renderReviewComment(comment) {
                const canDelete = currentUser && (currentUser.uid === comment.userId || currentUser.role === 'admin');
                const timeAgo = comment.createdAt ? timeSince(comment.createdAt.toDate()) : 'الآن';

                return `
                    <div class="review-comment-item">
                         <img src="${comment.userImage || 'https://placehold.co/32x32/8B4513/FFFFFF?text=R'}" alt="${comment.userName}" class="comment-avatar !w-8 !h-8">
                         <div class="comment-body">
                            <div class="comment-header">
                                <span class="comment-user">${comment.userName}</span>
                                <span class="comment-timestamp">${timeAgo}</span>
                            </div>
                            <p class="comment-text text-sm">${comment.text.replace(/\n/g, '<br>')}</p>
                            <div class="comment-actions">
                                ${canDelete ? `<button class="comment-action-btn text-red-500 delete-comment-btn" data-comment-id="${comment.id}">حذف</button>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }

            async function handleReviewCommentSubmit(event) {
                event.preventDefault();
                const form = event.currentTarget;
                const reviewId = form.dataset.reviewId;
                const textarea = form.querySelector('textarea');
                const text = textarea.value.trim();

                if (!text || !reviewId || !currentUser) return;

                try {
                    await runTransaction(db, async (transaction) => {
                        const reviewRef = doc(db, "reviews", reviewId);
                        transaction.update(reviewRef, { commentsCount: increment(1) });
                        
                        const reviewCommentsRef = collection(db, "reviewComments");
                        transaction.set(doc(reviewCommentsRef), {
                            reviewId,
                            userId: currentUser.uid,
                            userName: currentUser.name,
                            userImage: currentUser.imageUrl || '',
                            text,
                            createdAt: serverTimestamp(),
                        });
                    });
                    textarea.value = '';
                } catch (error) {
                    console.error("Error adding review comment:", error);
                    showToast('فشل إضافة الرد.', 'error');
                }
            }


            function timeSince(date) {
              const seconds = Math.floor((new Date() - date) / 1000);
              let interval = seconds / 31536000;
              if (interval > 1) return `منذ ${Math.floor(interval)} سنة`;
              interval = seconds / 2592000;
              if (interval > 1) return `منذ ${Math.floor(interval)} شهر`;
              interval = seconds / 86400;
              if (interval > 1) return `منذ ${Math.floor(interval)} يوم`;
              interval = seconds / 3600;
              if (interval > 1) return `منذ ${Math.floor(interval)} ساعة`;
              interval = seconds / 60;
              if (interval > 1) return `منذ ${Math.floor(interval)} دقيقة`;
              return "الآن";
            }
            
            // --- Shopping Cart Logic ---
            const cartItemsContainer = document.getElementById('cart-items-container');
            const cartFooter = document.getElementById('cart-footer');
            const emptyCartMessage = document.getElementById('empty-cart-message');
            const cartTotalPriceEl = document.getElementById('cart-total-price');
            const cartBadge = document.getElementById('cart-badge');
            
            function handleAddToCart(event) {
                const button = event.currentTarget;
                const productId = button.dataset.productId;
                const name = button.dataset.productName;
                const price = parseFloat(button.dataset.productPrice);
                const image = button.dataset.productImage;
                const quantityInput = document.getElementById(`qty-${productId}`);
                const quantity = parseInt(quantityInput.value);

                if (isNaN(quantity) || quantity < 1) {
                    showToast('الرجاء إدخال كمية صحيحة.', 'error');
                    return;
                }

                const existingItem = cart.find(item => item.id === productId);

                if (existingItem) {
                    existingItem.quantity += quantity;
                } else {
                    cart.push({ id: productId, name, price, image, quantity });
                }
                
                showToast(`تمت إضافة "${name}" إلى السلة بنجاح!`, 'success');
                quantityInput.value = 1; // Reset quantity input
                renderCart();
            }

            function renderCart() {
                cartItemsContainer.innerHTML = ''; // Clear previous items

                if (cart.length === 0) {
                    cartFooter.classList.add('hidden');
                    emptyCartMessage.style.display = 'flex';
                } else {
                    cartFooter.classList.remove('hidden');
                    emptyCartMessage.style.display = 'none';

                    cart.forEach(item => {
                        const itemEl = document.createElement('div');
                        itemEl.className = 'cart-item';
                        itemEl.innerHTML = `
                            <img src="${item.image || 'https://placehold.co/70x70/EADDCA/5C4033?text=R'}" alt="${item.name}" class="cart-item-image">
                            <div class="cart-item-details">
                                <p class="cart-item-title">${item.name}</p>
                                <p class="cart-item-price">${item.price} جنيه</p>
                            </div>
                            <div class="cart-item-actions">
                                <input type="number" value="${item.quantity}" min="1" class="quantity-input" data-item-id="${item.id}">
                                <button class="remove-cart-item-btn" data-item-id="${item.id}" title="إزالة"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        `;
                        cartItemsContainer.appendChild(itemEl);
                    });

                    // Add event listeners for new elements
                    cartItemsContainer.querySelectorAll('.quantity-input').forEach(input => {
                        input.addEventListener('change', updateCartQuantity);
                    });
                    cartItemsContainer.querySelectorAll('.remove-cart-item-btn').forEach(btn => {
                        btn.addEventListener('click', removeFromCart);
                    });
                }
                
                updateCartSummary();
            }
            
            function updateCartQuantity(event) {
                const input = event.currentTarget;
                const itemId = input.dataset.itemId;
                const newQuantity = parseInt(input.value);
                
                const itemInCart = cart.find(item => item.id === itemId);

                if (itemInCart && newQuantity > 0) {
                    itemInCart.quantity = newQuantity;
                    updateCartSummary();
                } else if (itemInCart && newQuantity <= 0) {
                    // If quantity is 0 or less, remove the item
                    cart = cart.filter(item => item.id !== itemId);
                    renderCart(); // Re-render to remove the element
                }
            }

            function removeFromCart(event) {
                const button = event.currentTarget;
                const itemId = button.dataset.itemId;
                cart = cart.filter(item => item.id !== itemId);
                renderCart();
            }

            function updateCartSummary() {
                const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                cartTotalPriceEl.textContent = `${total.toFixed(2)} جنيه`;
                
                const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);;
                cartBadge.textContent = totalItems;
                cartBadge.classList.toggle('active', totalItems > 0);
            }

            async function handleCheckout() {
                if (cart.length === 0) {
                    showToast('سلتك فارغة!', 'error');
                    return;
                }
                
                const WHATSAPP_NUMBER = "+201016712554";
                let message = "👋 مرحباً ذات النقاب، أود طلب المنتجات التالية:\n\n";
                let total = 0;

                cart.forEach(item => {
                    const subtotal = item.price * item.quantity;
                    message += `* المنتج: ${item.name}\n`;
                    message += `* الكمية: ${item.quantity}\n`;
                    message += `* السعر: ${subtotal.toFixed(2)} جنيه\n`;
                    message += `------------------------\n`;
                    total += subtotal;
                });
                
                message += `\n*الإجمالي: ${total.toFixed(2)} جنيه*\n\n`;

                if(currentUser && currentUser.address) {
                    message += `*بياناتي:*\n`;
                    message += `الاسم: ${currentUser.name}\n`;
                    message += `العنوان: ${currentUser.address}\n`;
                    message += `رقم الهاتف: ${currentUser.phone || 'غير محدد'}\n`;
                } else {
                    message += `(برجاء إرسال بيانات الشحن لاستكمال الطلب)`;
                }
                
                const encodedMessage = encodeURIComponent(message);
                const whatsappUrl = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodedMessage}`;

                window.open(whatsappUrl, '_blank');
                
                try {
                    await showConfirmModal('تم توجيهك إلى واتساب لإرسال طلبك. هل نُفرغ السلة الآن؟', 'نعم، أفرغها', '!bg-green-500');
                    clearCart();
                } catch(err) {
                    // User cancelled, do nothing
                }
            }

            function clearCart() {
                cart = [];
                renderCart();
            }

            document.getElementById('clear-cart-btn').addEventListener('click', async () => {
                try {
                    await showConfirmModal('هل أنت متأكد من أنك تريد إفراغ السلة؟');
                    clearCart();
                    showToast('تم إفراغ السلة.', 'success');
                } catch(err) {
                    // User cancelled
                }
            });
            document.getElementById('checkout-btn').addEventListener('click', handleCheckout);


            // --- Page Initialization ---
            function initPage() {
                initializeModals();
                initPreloader();
                initStickyHeader();
                initMobileMenu();
                initScrollAnimations();
                initScrollToTop();
                initContactForm();
                initReviewModal();
                handleMultiImagePreview('category-images-input', 'category-images-preview');
                handleMultiImagePreview('product-images-input', 'product-images-preview');
                document.getElementById('add-category-form').addEventListener('submit', (e) => handleItemFormSubmit(e, 'category'));
                document.getElementById('add-product-form').addEventListener('submit', (e) => handleItemFormSubmit(e, 'product'));
                initHeroImageLogic();
                initMobileHeaderDropdown();
                renderCart(); // Initial render of the cart
            }

            function initScrollAnimations(){
                revealObserver = new IntersectionObserver((entries, observer) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            entry.target.classList.add('in-view');
                            observer.unobserve(entry.target);
                        }
                    });
                }, { threshold: 0.1, rootMargin: "0px 0px -50px 0px" });

                document.querySelectorAll('.fade-in-up').forEach(el => revealObserver.observe(el));
                
                const navObserver = new IntersectionObserver(entries => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            document.querySelectorAll('.nav-link').forEach(link => {
                                link.classList.remove('active');
                                if(link.dataset.section === entry.target.id) {
                                    link.classList.add('active');
                                }
                            });
                        }
                    });
                }, { rootMargin: '-40% 0px -60% 0px' });
                document.querySelectorAll('.nav-section').forEach(section => navObserver.observe(section));
            }

            function initHeroImageLogic() {
                const heroImageInput = document.getElementById('hero-image-input');
                const heroImageElement = document.getElementById('hero-image');
                
                async function getHeroImage() {
                    try {
                        const settingsDocRef = doc(db, 'settings', 'hero');
                        const docSnap = await getDoc(settingsDocRef);
                        if (docSnap.exists() && docSnap.data().imageUrl) {
                            heroImageElement.src = docSnap.data().imageUrl;
                        } else {
                            heroImageElement.src = 'That.jpg';
                        }
                    } catch (error) {
                        console.error("Error fetching hero image:", error);
                        heroImageElement.src = 'That.jpg';
                    }
                }
                getHeroImage();
               
                heroImageInput.addEventListener('change', async (e) => {
                    if (e.target.files[0]) {
                        const file = e.target.files[0];
                        showToast('جاري ضغط ورفع الصورة...', 'info', 0);
                        try {
                            const base64Image = await compressAndEncodeImage(file); 

                            heroImageElement.src = base64Image;
                            const settingsDocRef = doc(db, 'settings', 'hero');
                            await setDoc(settingsDocRef, { imageUrl: base64Image }, { merge: true });
                            showToast('تم تحديث الصورة الرئيسية بنجاح!', 'success');
                        } catch (error) {
                            console.error("Error uploading hero image:", error);
                            showToast('فشل في تحميل الصورة.', 'error');
                            getHeroImage(); 
                        }
                    }
                });
            }
            
            function initMobileHeaderDropdown() {
                const userDisplay = document.getElementById('mobile-header-user-display');
                const dropdown = document.getElementById('mobile-header-dropdown-menu');
                
                userDisplay?.addEventListener('click', (e) => {
                    dropdown.classList.toggle('visible');
                    dropdown.classList.toggle('opacity-0');
                    dropdown.classList.toggle('invisible');
                    e.stopPropagation();
                });
                
                document.addEventListener('click', (e) => {
                    if (dropdown?.classList.contains('visible') && !dropdown.contains(e.target) && !userDisplay?.contains(e.target)) {
                        dropdown.classList.add('opacity-0', 'invisible');
                        dropdown.classList.remove('visible');
                    }
                });
                
                document.getElementById('mobile-header-edit-profile-btn')?.addEventListener('click', (e) => {
                    e.preventDefault();
                    profileModal.open();
                });
            }

            initPage();
            
            function initPreloader(){const p=document.getElementById("preloader");window.addEventListener("load",()=>{p.style.opacity="0",setTimeout(()=>p.style.display="none",700)})}function initStickyHeader(){const e=document.getElementById("header");window.addEventListener("scroll",()=>{e.classList.toggle("scrolled",window.scrollY>50)},{passive:!0})}function initMobileMenu(){const e=document.body,t=document.getElementById("header"),n=document.getElementById("mobile-menu-button"),o=document.getElementById("mobile-menu"),i=n.querySelector("i");const d=()=>{const d=e.classList.toggle("mobile-menu-open");o.classList.toggle("translate-x-full"),i.classList.toggle("fa-bars"),i.classList.toggle("fa-times"),n.setAttribute("aria-label",d?"إغلاق القائمة":"فتح القائمة");const l=o.querySelectorAll(".mobile-nav-link");d?(e.style.overflow="hidden",t.style.zIndex="120",l.forEach((e,t)=>{e.style.transitionDelay=`${100*t+150}ms`})) :(e.style.overflow="",t.style.zIndex="",l.forEach(e=>{e.style.transitionDelay="0ms"}))};n.addEventListener("click",d),document.querySelectorAll(".mobile-nav-link, #mobile-menu button").forEach(t=>{t.addEventListener("click",()=>{e.classList.contains("mobile-menu-open")&&d()})})}function initScrollToTop(){const e=document.getElementById("scroll-to-top");window.addEventListener("scroll",()=>{e.classList.toggle("visible",window.scrollY>300)},{passive:!0}),e.addEventListener("click",()=>{window.scrollTo({top:0,behavior:"smooth"})})}function initContactForm(){const e=document.getElementById("contact-form");if(!e)return;const t=document.getElementById("form-status");e.addEventListener("submit",function(e){e.preventDefault(),t.textContent="جاري الإرسال...",t.style.color="var(--secondary)",setTimeout(()=>{t.textContent="تم استلام رسالتك بنجاح! سنتواصل معك قريباً.",t.style.color="var(--primary-dark)",this.reset(),setTimeout(()=>t.textContent="",4e3)},1e3)})}
        });
    </script>
</body>
</html>
